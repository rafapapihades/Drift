<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MASTER DRIFT SHOW - CONTROL</title>

<style>
*{box-sizing:border-box}
body{background:#000;color:#fff;font-family:sans-serif;padding:0 10px 10px;margin:0}

/* ---------- GEN√âRICO ---------- */
.card{background:#111;padding:14px;border-radius:12px;margin-bottom:10px;border:1px solid #333}
.btn{width:100%;padding:16px;border-radius:10px;border:none;font-weight:bold;margin-bottom:8px;cursor:pointer;text-transform:uppercase}
.btn-pista{opacity:.25}
.pista-activa{opacity:1!important;outline:3px solid #fff}

/* ---------- INPUT PILOTOS ---------- */
.input-group{display:flex;gap:8px}
input{flex:1;padding:14px;background:#000;color:#ffcc00;border:1px solid #444;border-radius:8px;font-size:1.3em;text-align:center}
.btn-lupa{width:60px;background:#222;border:1px solid #444;border-radius:8px;color:#ffcc00;font-size:1.5em}

/* ---------- MENSAJE A PISTA ---------- */
#panel-mensaje{margin-top:10px;padding-top:10px;border-top:1px solid #333}
#msg-text{width:100%;min-height:70px;max-height:160px;background:#000;color:#ffcc00;
border:1px solid #444;border-radius:10px;padding:10px;font-size:1em}
.msg-actions{display:flex;gap:8px;margin-top:8px}
.msg-hint{margin-top:6px;font-size:.75em;color:#888;text-align:center}

/* ---------- SESIONES ---------- */
#sesiones-resumen{font-size:.75em;color:#aaa;text-align:center;margin-top:6px}
#sesiones-lista{margin-top:8px;display:flex;flex-direction:column;gap:6px}
.session-row{
  background:#0d0d0d;border:1px solid #222;border-radius:10px;
  padding:8px 10px;display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center
}
.badge{padding:4px 8px;border-radius:999px;font-size:.7em;font-weight:bold}
.badge-online{background:#143;color:#9f9}
.badge-read{background:#440;color:#ffcc00}
.badge-pending{background:#411;color:#ff9a9a}
.badge-off{background:#222;color:#888}
</style>
</head>

<body>

<!-- PILOTOS -->
<div class="card">
  <div class="input-group">
    <input id="d-show" placeholder="DORSALES" oninput="buscarPilotoShow(this.value)">
    <button class="btn-lupa" onclick="abrirSelector()">üîç</button>
  </div>
  <div id="preview-show" style="text-align:center;margin-top:6px;color:#888">Introduce dorsal‚Ä¶</div>
</div>

<!-- CONTROL PISTA -->
<div class="card">
  <button id="btn-coche" class="btn btn-pista" style="background:#007bff" onclick="abrirVoto()">COCHE EN PISTA</button>
  <button id="btn-libre" class="btn btn-pista" style="background:green" onclick="setEstado('üü¢ PISTA LIBRE','green','btn-libre')">PISTA LIBRE</button>
  <button id="btn-obs" class="btn btn-pista" style="background:#ffcc00;color:#000" onclick="setEstado('‚ö†Ô∏è OBST√ÅCULO','#ffcc00','btn-obs')">OBST√ÅCULO</button>
  <button id="btn-acc" class="btn btn-pista" style="background:red" onclick="setEstado('üî¥ ACCIDENTE','red','btn-acc')">ACCIDENTE</button>

  <!-- MENSAJE -->
  <button class="btn" style="background:#ff8800;color:#000" onclick="toggleMensaje()">MENSAJE A PISTA</button>

  <div id="panel-mensaje" style="display:none">
    <textarea id="msg-text" placeholder="Mensaje para pista‚Ä¶"></textarea>
    <div class="msg-actions">
      <button class="btn" style="background:#ff8800;color:#000" onclick="enviarMensaje()">ENVIAR</button>
      <button class="btn" style="background:#333" onclick="borrarMensaje()">ELIMINAR</button>
    </div>
    <div id="msg-hint" class="msg-hint">Sin mensaje activo</div>

    <div id="sesiones-resumen">Online: 0 ¬∑ Le√≠do: 0 ¬∑ Pendiente: 0</div>
    <div id="sesiones-lista"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const db = getDatabase(initializeApp({
  databaseURL:"https://lectura-sonido-drift-show-default-rtdb.firebaseio.com"
}));

/* -------- MENSAJE -------- */
let panel=document.getElementById('panel-mensaje');
window.toggleMensaje=()=>panel.style.display=panel.style.display?'':'block';

window.enviarMensaje=async()=>{
  const t=msgText.value.trim();
  if(!t)return;
  await set(ref(db,'mensaje_pista'),{texto:t,ts:Date.now()});
  msgHint.innerText="Mensaje enviado";
};
window.borrarMensaje=async()=>{
  await set(ref(db,'mensaje_pista'),null);
  panel.style.display='none';
};

/* -------- SESIONES -------- */
let msgTs=0;
onValue(ref(db,'mensaje_pista'),s=>{msgTs=s.val()?.ts||0});

onValue(ref(db,'pista_sessions'),snap=>{
  const now=Date.now();
  const all=snap.val()||{};
  const online=Object.entries(all).filter(([_,s])=>now-(s.lastSeen||0)<15000);

  let leidos=0;
  online.forEach(([_,s])=>{ if(msgTs && (s.lastReadTs||0)>=msgTs) leidos++; });

  sesionesResumen.innerText=
    `Online: ${online.length} ¬∑ Le√≠do: ${leidos} ¬∑ Pendiente: ${online.length-leidos}`;

  sesionesLista.innerHTML=online.map(([id,s])=>{
    const read=(s.lastReadTs||0)>=msgTs;
    return `
      <div class="session-row">
        <div>${id}</div>
        <span class="badge badge-online">ONLINE</span>
        <span class="badge ${read?'badge-read':'badge-pending'}">
          ${read?'LE√çDO':'PENDIENTE'}
        </span>
      </div>`;
  }).join('');
});
</script>
</body>
</html>
