<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>MASTER DRIFT SHOW - CONTROL</title>

  <style>
    * { box-sizing: border-box; }
    body { background: #000; color: #fff; font-family: sans-serif; padding: 0 10px 10px 10px; margin: 0; overflow-x: hidden; }

    .header-logo { display:block; margin:0 auto; width:100%; max-width:500px; height:auto; padding:5px 0; }
    .card { background:#111; padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid #333; width:100%; }

    .btn { width:100%; padding:18px; border-radius:10px; border:none; font-weight:bold; margin-bottom:8px; cursor:pointer; transition:0.3s; color:white; text-transform:uppercase; }
    .btn-pista { opacity:0.25; }
    .pista-activa { opacity:1 !important; transform:scale(1.02); outline:3px solid #fff; box-shadow:0 0 20px rgba(255,255,255,0.5); }

    .input-group { display:flex; gap:8px; width:100%; }
    input { flex:1; min-width:0; padding:15px; background:#000; color:#ffcc00; border:1px solid #444; border-radius:8px; text-align:center; font-size:1.4em; }
    .btn-lupa { width:60px; flex-shrink:0; background:#222; border:1px solid #444; border-radius:8px; color:#ffcc00; font-size:1.5em; cursor:pointer; display:flex; align-items:center; justify-content:center; }

    .vote-stats-container { margin:10px 0; }
    .piloto-voto-row { background:#222; padding:10px; border-radius:8px; margin-bottom:5px; border-left:4px solid #ffcc00; }
    .p-info { font-weight:bold; font-size:0.9em; margin-bottom:5px; color:#fff; text-transform:uppercase; }
    .p-sub { margin-top:2px; color:#aaa; font-style:italic; font-size:0.85em; text-transform:none; }
    .p-stats { display:flex; justify-content:space-around; color:#ffcc00; font-size:1.1em; }

    .timer-master { background:#ff4444; color:white; padding:10px; border-radius:8px; font-weight:bold; margin-bottom:10px; font-size:1.2em; animation:parpadeo 1s infinite; text-align:center; }
    @keyframes parpadeo { 50% { opacity:0.5; } }

    .btn-reset { background:#444; opacity:1; font-size:0.7em; margin-top:5px; }
    .btn-cargar { background:#222; border:1px dashed #444; color:#bbb; font-size:0.8em; margin-top:5px; padding:12px; margin-bottom:5px; }

    .pilotos-count { color:#888; font-size:0.75em; margin:2px 0 12px 0; text-align:center; text-transform:uppercase; font-weight:bold; }

    #modal-selector { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; flex-direction:column; padding:10px; }
    .grid-pilotos { display:grid; grid-template-columns:1fr 1fr; gap:8px; overflow-y:auto; flex:1; }
    .btn-piloto-selec { background:#111; border:1px solid #333; color:#fff; padding:10px; border-radius:8px; text-align:center; min-height:70px; display:flex; flex-direction:column; justify-content:center; }
    .btn-piloto-selec.selected { background:#332200; border-color:#ffcc00; }
    .car-mini { color:#aaa; font-style:italic; font-size:0.85em; margin-top:4px; }

    /* MENSAJE A PISTA (DESPLEGABLE) */
    #panel-mensaje { display:none; margin-top:10px; background:#0d0d0d; border:1px solid #333; border-radius:12px; padding:12px; }
    #msg-text { width:100%; min-height:70px; padding:12px; border-radius:10px; border:1px solid #444; background:#000; color:#ffcc00; font-size:1.0em; outline:none; resize:vertical; }
    .msg-actions { display:flex; gap:10px; margin-top:10px; }
    .btn-mini { padding:14px; border-radius:10px; border:none; font-weight:bold; cursor:pointer; text-transform:uppercase; }
    .btn-send { flex:2; background:#ff8800; color:#000; }
    .btn-del  { flex:1; background:#444; color:#fff; }
    .msg-hint { margin-top:10px; font-size:0.85em; color:#888; text-transform:uppercase; font-weight:bold; text-align:center; }

    /* SESIONES */
    #panel-sesiones { margin-top:12px; padding-top:12px; border-top:1px solid #333; }
    .sesion-row{ background:#121212; border:1px solid #333; border-radius:10px; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; gap:10px; }
    .sesion-left{ color:#fff; font-weight:bold; font-size:0.9em; }
    .sesion-right{ font-weight:bold; text-transform:uppercase; font-size:0.85em; }
    .badge-ok{ color:#00ff99; }
    .badge-warn{ color:#ffcc00; }
    .badge-off{ color:#888; }

    /* ERROR BAR (solo si hay error) */
    #dbg{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:9999;
      background:#6b0000; border:1px solid #ff4444; border-radius:12px; padding:10px;
      text-align:left; font-weight:bold; color:#fff; opacity:.95; display:none;
      white-space:pre-wrap;
    }
  </style>

  <!-- Firebase COMPAT -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>

<body>

  <div id="modal-selector">
    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <button class="btn" style="background:#444; flex:1" onclick="cerrarSelector()">‚úï</button>
      <button class="btn" style="background:green; flex:1" onclick="confirmarSeleccion()">‚úì LISTO</button>
    </div>
    <div id="lista-botones-pilotos" class="grid-pilotos"></div>
  </div>

  <img src="logo2.jpg" alt="Logo" class="header-logo">

  <div class="card">
    <div class="input-group">
      <input type="text" id="d-show" placeholder="DORSALES" oninput="buscarPilotoShow(this.value)">
      <button class="btn-lupa" onclick="abrirSelector()">üîç</button>
    </div>
    <div id="preview-show" style="text-align:center; margin-top:10px; color:#aaa; font-weight:bold;">Introduce dorsal...</div>
  </div>

  <div class="card">
    <button id="btn-coche" class="btn btn-pista" style="background:#007bff" onclick="abrirVoto()">COCHE EN PISTA</button>

    <div id="votos-en-vivo" class="vote-stats-container"></div>

    <button id="btn-libre" class="btn btn-pista" style="background:green" onclick="setEstado('üü¢ PISTA LIBRE', 'green', 'btn-libre')">PISTA LIBRE</button>
    <button id="btn-obs" class="btn btn-pista" style="background:#ffcc00; color:black" onclick="setEstado('‚ö†Ô∏è OBST√ÅCULO', '#ffcc00', 'btn-obs')">OBST√ÅCULO</button>
    <button id="btn-acc" class="btn btn-pista" style="background:red" onclick="setEstado('üî¥ ACCIDENTE', 'red', 'btn-acc')">ACCIDENTE</button>

    <button id="btn-msg" class="btn" style="background:#ff8800; color:#000" onclick="togglePanelMensaje()">MENSAJE A PISTA</button>

    <div id="panel-mensaje">
      <textarea id="msg-text" placeholder="Escribe el mensaje para PISTA..."></textarea>

      <div class="msg-actions">
        <button class="btn-mini btn-send" onclick="enviarMensajePista()">ENVIAR</button>
        <button class="btn-mini btn-del" onclick="eliminarMensajePista()">ELIMINAR</button>
      </div>

      <div class="msg-hint" id="msg-hint">Listo</div>

      <div id="panel-sesiones">
        <div class="msg-hint" style="margin-top:0;">SESIONES PISTA</div>
        <div id="sesiones-resumen" class="msg-hint" style="display:block; margin-top:8px;">Online: 0 ¬∑ Le√≠do: 0</div>
        <div id="sesiones-lista" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <button class="btn btn-cargar" onclick="document.getElementById('xl-d').click()">üìÇ CARGAR DRIFT.CSV</button>
    <div id="txt-count" class="pilotos-count">PILOTOS CARGADOS: 0</div>
    <input type="file" id="xl-d" accept=".csv" style="display:none" onchange="cargarCSV(event)">
    <button class="btn btn-reset" onclick="exportarVotos()">üíæ DESCARGAR VOTOS Y LIMPIAR</button>
  </div>

  <div id="dbg"></div>

  <script>
    // ===== visor de errores (m√≥vil-friendly) =====
    function showDbg(msg){
      var el = document.getElementById('dbg');
      if(!el) return;
      el.style.display = 'block';
      el.textContent = msg;
    }
    window.addEventListener('error', function(e){
      showDbg("ERROR JS:\n" + (e.message || e.error || "desconocido") + "\n" + (e.filename||"") + ":" + (e.lineno||"") );
    });
    window.addEventListener('unhandledrejection', function(e){
      var r = e && e.reason ? (e.reason.message || String(e.reason)) : "desconocido";
      showDbg("PROMESA RECHAZADA:\n" + r);
    });

    // ===== Helpers COMPAT: reemplazo de .get() =====
    function getOnce(path){
      return new Promise(function(resolve, reject){
        firebase.database().ref(path).once('value', resolve, reject);
      });
    }

    try {
      firebase.initializeApp({ databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" });
      var db = firebase.database();

      var inscritosD = {};
      var seleccionados = [];

      var panelManual = false;
      var currentMsgTs = 0;
      var ONLINE_MS = 15000;

      function mostrarPanelMensaje(show){
        document.getElementById('panel-mensaje').style.display = show ? 'block' : 'none';
      }

      // ===== funciones UI (definidas SIEMPRE) =====
      window.togglePanelMensaje = function(){
        panelManual = true;
        var panel = document.getElementById('panel-mensaje');
        var visible = panel.style.display !== 'none' && panel.style.display !== '';
        mostrarPanelMensaje(!visible);
      };

      window.enviarMensajePista = async function(){
        var texto = (document.getElementById('msg-text').value || "").trim();
        var hint = document.getElementById('msg-hint');
        if(!texto){ hint.innerText = "Escribe un mensaje"; return; }
        hint.innerText = "Enviando...";
        var payload = { texto: texto, ts: Date.now() };
        await db.ref('mensaje_pista').set(payload);
        hint.innerText = "Enviado ‚úÖ";
      };

      window.eliminarMensajePista = async function(){
        var hint = document.getElementById('msg-hint');
        hint.innerText = "Eliminando...";
        await db.ref('mensaje_pista').remove();
        document.getElementById('msg-text').value = "";
        hint.innerText = "Eliminado";
        panelManual = false;
        mostrarPanelMensaje(false);
      };

      window.buscarPilotoShow = function(val){
        if(!val.trim()){
          document.getElementById('preview-show').innerText = "Introduce dorsal...";
          return;
        }
        var dorsales = val.trim().split(/\s+/);
        var encontrados = dorsales.map(function(d){
          var p = inscritosD[d];
          if(!p) return (d ? "?" : "");
          var coche = (p.coche || "").trim();
          return coche ? (p.piloto + " (" + coche + ")") : p.piloto;
        }).filter(Boolean);

        document.getElementById('preview-show').innerText =
          encontrados.length ? encontrados.join(' | ') : "Piloto no encontrado";
      };

      window.abrirSelector = function(){
        var grid = document.getElementById('lista-botones-pilotos');
        grid.innerHTML = "";
        seleccionados = [];

        Object.keys(inscritosD).sort(function(a,b){ return Number(a)-Number(b); }).forEach(function(d){
          var p = inscritosD[d] || {};
          var coche = (p.coche || "").trim();
          var btn = document.createElement('div');
          btn.className = 'btn-piloto-selec';
          btn.innerHTML =
            "<b>#"+d+"</b><br><small>"+(p.piloto||"")+"</small>" +
            (coche ? "<div class='car-mini'>"+coche+"</div>" : "");
          btn.onclick = function(){
            btn.classList.toggle('selected');
            if(seleccionados.includes(d)) seleccionados = seleccionados.filter(function(x){ return x!==d; });
            else seleccionados.push(d);
          };
          grid.appendChild(btn);
        });

        document.getElementById('modal-selector').style.display = 'flex';
      };

      window.cerrarSelector = function(){ document.getElementById('modal-selector').style.display = 'none'; };
      window.confirmarSeleccion = function(){
        var val = seleccionados.join(" ");
        document.getElementById('d-show').value = val;
        window.buscarPilotoShow(val);
        window.cerrarSelector();
      };

      window.cargarCSV = function(event){
        var file = event.target.files && event.target.files[0];
        if(!file) return;

        var reader = new FileReader();
        reader.onload = function(e){
          var lines = String(e.target.result||"").split(/\r?\n/);
          var obj = {};
          var sep = (lines[0] && lines[0].includes(';')) ? ';' : ',';

          lines.slice(1).forEach(function(l){
            if(!l.trim()) return;
            var c = l.split(sep);
            if(c[0]) obj[c[0].trim()] = { piloto:(c[1]||"").trim(), coche:(c[2]||"").trim() };
          });

          db.ref('inscritos_drift').set(obj).then(function(){
            alert("Cargados " + Object.keys(obj).length + " pilotos");
            event.target.value = "";
          });
        };
        reader.readAsText(file);
      };

      

window.exportarVotos = async function () {
  // Lee historial
  const snapHist = await getOnce('historial_votos');
  if (!snapHist.exists()) return alert("No hay historial");

  const histObj = snapHist.val() || {};
  let rows = Object.values(histObj).filter(r => r && r.dorsal && r.ts);

  // Orden cronol√≥gico
  rows.sort((a, b) => (a.ts || 0) - (b.ts || 0));

  // Lee inscritos para nombre+coche (no depende de variables del try)
  const snapIns = await getOnce('inscritos_drift');
  const inscritos = (snapIns.exists() && snapIns.val()) ? snapIns.val() : {};

  const CLUSTER_MS = 1500;
  const ONLINE_SCORE = (ap, up, dw) => (ap * 2) + up - dw;

  // Agrupar por tanda para detectar participantes de BATALLA
  const clusters = [];
  let cur = [];
  for (const r of rows) {
    if (!cur.length) { cur.push(r); continue; }
    const prev = cur[cur.length - 1];
    if ((r.ts - (prev.ts || 0)) <= CLUSTER_MS) cur.push(r);
    else { clusters.push(cur); cur = [r]; }
  }
  if (cur.length) clusters.push(cur);

  clusters.forEach(c => {
    let battle = null;
    const parts = [];
    for (const r of c) {
      const d = String(r.dorsal || "");
      if (d === "BATALLA") battle = r;
      else parts.push(d);
    }
    if (battle) {
      battle._participants = (parts.length === 2) ? `${parts[0]} vs ${parts[1]}` : (parts.join(" ") || "?");
    }
  });

  function fmtDate(ts) {
    return ts ? new Date(ts).toLocaleString('es-ES').replace(/,/g, '') : "";
  }
  function esc(s) { return String(s || "").replace(/"/g, ''); }

  // 1) Agregar PILOTOS
  const agg = {}; // dorsal -> datos
  function ensurePilot(d) {
    if (!agg[d]) {
      const p = inscritos[d];
      agg[d] = {
        dorsal: d,
        nombre: p ? (p.piloto || ("PILOTO " + d)) : ("PILOTO " + d),
        coche: p ? (p.coche || "") : "",
        ap: 0, up: 0, dw: 0,
        veces: 0,
        firstTs: null,
        lastTs: null
      };
    }
    return agg[d];
  }

  // 2) Agregar BATALLAS
  const battAgg = {}; // key -> datos
  function ensureBattle(key) {
    if (!battAgg[key]) {
      battAgg[key] = { participantes: key, ap: 0, up: 0, dw: 0, veces: 0, firstTs: null, lastTs: null };
    }
    return battAgg[key];
  }

  for (const v of rows) {
    const dorsal = String(v.dorsal || "");
    const ap = Number(v.ap || 0), up = Number(v.up || 0), dw = Number(v.dw || 0);

    if (dorsal === "BATALLA") {
      const key = v._participants || "?";
      const b = ensureBattle(key);
      b.ap += ap; b.up += up; b.dw += dw;
      b.veces += 1;
      if (b.firstTs === null || v.ts < b.firstTs) b.firstTs = v.ts;
      if (b.lastTs === null || v.ts > b.lastTs) b.lastTs = v.ts;
      continue;
    }

    const p = ensurePilot(dorsal);
    p.ap += ap; p.up += up; p.dw += dw;
    p.veces += 1;
    if (p.firstTs === null || v.ts < p.firstTs) p.firstTs = v.ts;
    if (p.lastTs === null || v.ts > p.lastTs) p.lastTs = v.ts;
  }

  // Orden pilotos por score desc
  const pilotos = Object.values(agg).map(p => ({ ...p, score: ONLINE_SCORE(p.ap, p.up, p.dw) }));
  pilotos.sort((a, b) => (b.score - a.score) || (b.ap - a.ap) || (Number(a.dorsal) - Number(b.dorsal)));

  // Orden batallas por score desc
  const batallas = Object.values(battAgg).map(b => ({ ...b, score: ONLINE_SCORE(b.ap, b.up, b.dw) }));
  batallas.sort((a, b) => (b.score - a.score) || (b.ap - a.ap) || String(a.participantes).localeCompare(String(b.participantes)));

  // CSV Pilotos
  let csvPilotos = "Rank,Dorsal,Piloto,Coche,Aplausos,Up,Down,Score,Veces,Primera,Ultima\n";
  pilotos.forEach((p, idx) => {
    csvPilotos +=
      `${idx + 1},${esc(p.dorsal)},"${esc(p.nombre)}","${esc(p.coche)}",` +
      `${p.ap},${p.up},${p.dw},${p.score},${p.veces},` +
      `"${esc(fmtDate(p.firstTs))}","${esc(fmtDate(p.lastTs))}"\n`;
  });

  // CSV Batallas
  let csvBatallas = "Rank,Participantes,Aplausos,Up,Down,Score,Veces,Primera,Ultima\n";
  batallas.forEach((b, idx) => {
    csvBatallas +=
      `${idx + 1},"${esc(b.participantes)}",${b.ap},${b.up},${b.dw},${b.score},${b.veces},` +
      `"${esc(fmtDate(b.firstTs))}","${esc(fmtDate(b.lastTs))}"\n`;
  });

  function downloadCsv(filename, content) {
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob(["\ufeff" + content], { type: 'text/csv;charset=utf-8;' }));
    link.download = filename;
    link.click();
  }

  downloadCsv("ranking_pilotos.csv", csvPilotos);
  setTimeout(() => downloadCsv("batallas.csv", csvBatallas), 250);

  if (confirm("¬øBorrar historial de la nube?")) {
    firebase.database().ref('historial_votos').remove();
  }
};

      window.abrirVoto = async function(){
        var val = document.getElementById('d-show').value.trim();
        if(!val) return alert("Introduce un dorsal primero");

        var dorsalesArr = val.split(/\s+/);
        var items = {};

        var histSnap = await getOnce('historial_votos');
        var historial = histSnap.exists() ? Object.values(histSnap.val()) : [];

        dorsalesArr.forEach(function(d){
          var p = inscritosD[d];
          var h_ap=0, h_up=0, h_dw=0;
          historial.filter(function(h){ return h.dorsal===d; }).forEach(function(v){
            h_ap += (v.ap||0); h_up += (v.up||0); h_dw += (v.dw||0);
          });
          items[d] = {
            nombre: p ? p.piloto : ("PILOTO " + d),
            coche: p ? (p.coche||"") : "",
            ap:0, up:0, dw:0, h_ap:h_ap, h_up:h_up, h_dw:h_dw
          };
        });

        if(dorsalesArr.length > 1) items["BATALLA"] = { nombre:"üî• BATALLA", coche:"", ap:0, up:0, dw:0, h_ap:0, h_up:0, h_dw:0 };

        await db.ref('votacion_activa').set({ dorsal: val, activa:true, timer:0, items: items });
        await db.ref('estado_pista').set({ mensaje:'üèéÔ∏è EN PISTA: ' + val, color:'#007bff', id:'btn-coche' });
      };

      window.setEstado = async function(msg, col, id){
        await db.ref('estado_pista').set({ mensaje: msg, color: col, id: id });

        if(id === 'btn-libre'){
          document.getElementById('d-show').value = "";
          document.getElementById('preview-show').innerText = "Introduce dorsal...";

          var snap = await getOnce('votacion_activa');
          var v = snap.val();

          if(v && v.activa){
            Object.entries(v.items).forEach(function(pair){
              var idItem = pair[0], data = pair[1];
              if((data.ap||0)+(data.up||0)+(data.dw||0) > 0){
                db.ref('historial_votos').push({ dorsal:idItem, info:data.nombre, ap:data.ap||0, up:data.up||0, dw:data.dw||0, ts:Date.now() });
              }
            });

            var count = 5;
            await db.ref('votacion_activa').update({ timer: count });
            var interval = setInterval(async function(){
              count--;
              await db.ref('votacion_activa').update({ timer: count });
              if(count <= 0){
                clearInterval(interval);
                await db.ref('votacion_activa').set({ activa:false, timer:0, dorsal:"" });
              }
            }, 1000);
          }
        }
      };

      // ===== listeners Firebase (sin tocar l√≥gica) =====
      db.ref('mensaje_pista').on('value', function(snap){
        var m = snap.val();
        if(m && m.ts && m.texto){
          currentMsgTs = m.ts;
          var txtEl = document.getElementById('msg-text');
          if(!txtEl.value.trim()) txtEl.value = m.texto;
          mostrarPanelMensaje(true);
          document.getElementById('msg-hint').innerText = "Mensaje activo";
        } else {
          currentMsgTs = 0;
          if(!panelManual) mostrarPanelMensaje(false);
          document.getElementById('msg-hint').innerText = "Listo";
        }
      });

      db.ref('pista_sessions').on('value', function(snap){
        var all = snap.val() || {};
        var now = Date.now();
        var entries = Object.entries(all).map(function(pair){
          var id = pair[0], s = pair[1] || {};
          s.id = id;
          return s;
        });
        var online = entries.filter(function(s){ return (now - (s.lastSeen||0)) <= ONLINE_MS; });

        var leidos = 0;
        if(currentMsgTs){
          leidos = online.filter(function(s){ return (s.lastReadTs||0) >= currentMsgTs; }).length;
        }
        document.getElementById('sesiones-resumen').innerText = "Online: " + online.length + " ¬∑ Le√≠do: " + leidos;

        var cont = document.getElementById('sesiones-lista');
        online.sort(function(a,b){ return (b.lastSeen||0) - (a.lastSeen||0); });

        cont.innerHTML = online.length ? online.map(function(s){
          var seenAgo = Math.max(0, Math.round((now - (s.lastSeen||0))/1000));
          var readOk = currentMsgTs && ((s.lastReadTs||0) >= currentMsgTs);
          var estadoTxt = !currentMsgTs ? "SIN MENSAJE" : (readOk ? "LE√çDO" : "PENDIENTE");
          var estadoCls = !currentMsgTs ? "badge-off" : (readOk ? "badge-ok" : "badge-warn");
          return "<div class='sesion-row'>" +
            "<div class='sesion-left'>" + s.id + "</div>" +
            "<div class='sesion-right "+estadoCls+"'>" + estadoTxt + " ¬∑ " + seenAgo + "s</div>" +
          "</div>";
        }).join('') : "<div class='msg-hint' style='margin-top:8px;'>No hay sesiones online</div>";
      });

      db.ref('inscritos_drift').on('value', function(s){
        inscritosD = s.val() || {};
        document.getElementById('txt-count').innerText = "PILOTOS CARGADOS: " + Object.keys(inscritosD).length;
      });

      db.ref('comando_limpiar').on('value', function(snapshot){
        if(snapshot.exists()){
          document.getElementById('d-show').value = "";
          document.getElementById('preview-show').innerText = "Introduce dorsal...";
        }
      });

      db.ref('votacion_activa').on('value', function(snap){
        var v = snap.val();
        var container = document.getElementById('votos-en-vivo');
        if(!v || !v.activa){ container.innerHTML=""; return; }

        var html = (v.timer > 0) ? ("<div class='timer-master'>‚è±Ô∏è CIERRE EN: " + v.timer + "s</div>") : "";
        if(v.items){
          html += Object.entries(v.items).map(function(pair){
            var id = pair[0], data = pair[1] || {};
            var coche = String(data.coche||"").trim();
            var sub = (id === 'BATALLA') ? "" : (coche ? ("<div class='p-sub'>" + coche + "</div>") : "");
            return "<div class='piloto-voto-row'>" +
              "<div class='p-info'>" + (id==='BATALLA' ? "üî• BATALLA" : ("#" + id + " " + data.nombre)) + sub + "</div>" +
              "<div class='p-stats'>" +
                "<span>üëè " + (data.ap||0) + " (" + ((data.ap||0)+(data.h_ap||0)) + ")</span>" +
                "<span>üëç " + (data.up||0) + " (" + ((data.up||0)+(data.h_up||0)) + ")</span>" +
                "<span>üëé " + (data.dw||0) + " (" + ((data.dw||0)+(data.h_dw||0)) + ")</span>" +
              "</div>" +
            "</div>";
          }).join('');
        }
        container.innerHTML = html;
      });

      db.ref('estado_pista').on('value', function(s){
        document.querySelectorAll('.btn-pista').forEach(function(b){ b.classList.remove('pista-activa'); });
        var id = s.val() && s.val().id;
        if(id){
          var active = document.getElementById(id);
          if(active) active.classList.add('pista-activa');
        }
      });

    } catch(err){
      showDbg("ERROR INIT:\n" + (err && err.message ? err.message : String(err)));
    }
  </script>
</body>
</html>
