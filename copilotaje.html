<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOG√çSTICA TAXI DRIFT</title>
    <style>
        :root { --accent: #ffcc00; --bg: #111; --card: rgba(25, 25, 25, 0.95); --green: #28a745; --red: #ff0000; --blue: #007bff; }
        
        body { 
            background-image: url('Fibra3.png'); 
            background-repeat: repeat; 
            color: #fff; 
            font-family: 'Arial Black', Gadget, sans-serif; 
            padding: 10px; margin: 0; 
        }
        
        .header-top { 
            display: flex; flex-direction: column; align-items: center; 
            padding: 15px; background: rgba(0,0,0,0.9); border-radius: 12px; 
            border: 2px solid #333; margin-bottom: 15px; gap: 12px; 
        }
        .brand { color: var(--red); font-size: 2.5em; font-weight: 900; letter-spacing: -1px; text-shadow: 2px 2px 0 #000; }
        
        .event-name-input { 
            background: transparent; border: none; border-bottom: 2px solid #444; 
            color: var(--accent); font-size: 1.2em; text-align: center; width: 90%; 
            font-family: 'Arial Black', sans-serif; outline: none;
        }

        .controls-row { display: flex; width: 100%; gap: 8px; justify-content: flex-end; }
        .btn-mini { background: #222; color: #ccc; border: 1px solid #444; padding: 10px 14px; border-radius: 6px; font-size: 0.75em; text-transform: uppercase; cursor: pointer; font-family: sans-serif; font-weight: bold; }
        .btn-reset { color: var(--red); border-color: #522; }

        .main-card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #444; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .input-huge { width: 100%; height: 60px; background: #000; border: 1px solid #444; border-radius: 10px; color: #fff; font-size: 1.2em; padding: 0 15px; box-sizing: border-box; margin-bottom: 15px; font-family: sans-serif; }
        
        /* AVISO DE REPETIDO */
        .asistente-aviso {
            background: #4a0000; color: #ffadad; padding: 12px; border-radius: 10px; 
            margin-bottom: 15px; display: none; font-size: 0.9em; 
            border: 2px solid var(--red); font-family: sans-serif; line-height: 1.4;
        }

        .doc-box { background: #000; border: 1px solid var(--accent); border-radius: 10px; padding: 10px; text-align: center; margin-bottom: 15px; }
        .doc-box small { display: block; font-size: 0.6em; color: #666; font-family: sans-serif; margin-bottom: 2px; }
        .doc-box b { font-size: 2.8em; font-family: monospace; color: var(--accent); }

        .chk-massive { width: 100%; height: 65px; background: #1a1a1a; border-radius: 10px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; gap: 15px; cursor: pointer; margin-bottom: 20px; }
        .chk-massive input { transform: scale(2); }

        .btn-add-massive { width: 100%; height: 75px; background: var(--green); color: #fff; border: none; border-radius: 12px; font-weight: 900; font-size: 1.3em; text-transform: uppercase; cursor: pointer; box-shadow: 0 6px 0 #155d27; }
        .btn-add-massive:disabled { background: #333; color: #555; box-shadow: none; opacity: 0.5; }

        .table-card { background: rgba(0,0,0,0.95); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #444; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 15px 5px; border-bottom: 1px solid #222; }
        
        .n-papel-cola { color: #000; background: var(--accent); font-weight: 900; font-family: monospace; font-size: 1.4em; padding: 5px 10px; border-radius: 5px; display: inline-block; min-width: 45px; text-align: center; }
        .time-tag { font-size: 0.7em; color: var(--blue); font-family: sans-serif; font-weight: bold; margin-left: 5px; }
        .car-tag { color: var(--accent); font-weight: bold; font-size: 0.85em; text-transform: uppercase; font-family: sans-serif; }
        
        .ready-container { display: flex; flex-direction: column; align-items: center; font-size: 0.65em; font-weight: bold; min-width: 100px; text-align: center; }
        .status-chk { transform: scale(2.2); cursor: pointer; margin-bottom: 8px; }
        .label-dentro { color: var(--green); }
        .label-fuera { color: #666; }
    </style>
</head>
<body>

    <div class="header-top">
        <span class="brand">TAXI DRIFT</span>
        <input type="text" id="nombre-evento" class="event-name-input" placeholder="NOMBRE DEL EVENTO">
        <div class="controls-row">
            <button class="btn-mini" onclick="document.getElementById('csv-pilotos').click()">CARGAR PILOTOS (<span id="count-tag">0</span>)</button>
            <button class="btn-mini btn-reset" id="btn-reset">EXPORTAR Y REINICIAR</button>
        </div>
        <input type="file" id="csv-pilotos" hidden accept=".csv">
    </div>

    <div class="main-card">
        <div id="aviso-repetido" class="asistente-aviso"></div>
        <input type="text" id="c-nombre" class="input-huge" placeholder="NOMBRE DEL PARTICIPANTE" autocomplete="off">
        
        <select id="c-piloto" class="input-huge"></select>
        
        <div class="doc-box">
            <small>N¬∫ DOCUMENTO CORRELATIVO</small>
            <b id="v-proximo-numero">001</b>
        </div>

        <label class="chk-massive">
            <input type="checkbox" id="c-firma"> 
            <span style="font-family: sans-serif; font-weight: bold;">RESPONSABILIDAD FIRMADA</span>
        </label>

        <button id="btn-add" class="btn-add-massive" disabled>CONFIRMAR REGISTRO</button>
    </div>

    <div class="table-card">
        <div style="font-size:0.8em; color:var(--accent); font-weight:bold; margin-bottom:15px; text-transform: uppercase;">üìã Cola de Acceso</div>
        <table id="tabla-espera"></table>
    </div>

    <div class="table-card">
        <div style="font-size:0.8em; color:var(--green); font-weight:bold; margin-bottom:15px; text-transform: uppercase;">üèÅ √öltimos en Pista</div>
        <table id="tabla-completados"></table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let pilotosArray = [];
        let registroRecuperado = null;

        const nombreInput = document.getElementById('c-nombre');
        const avisoBox = document.getElementById('aviso-repetido');
        const firmaChk = document.getElementById('c-firma');
        const btnAdd = document.getElementById('btn-add');

        // --- VALIDACI√ìN EN TIEMPO REAL ---
        nombreInput.addEventListener('input', async () => {
            const nombreBusqueda = nombreInput.value.trim().toLowerCase();
            
            if (nombreBusqueda.length < 3) {
                avisoBox.style.display = 'none';
                registroRecuperado = null;
                fnValidar();
                return;
            }

            const snap = await get(ref(db, 'copilotajes'));
            const data = snap.val() || {};
            
            const todos = [...Object.values(data.espera || {}), ...Object.values(data.completados || {})];
            const encontrado = todos.find(r => r.copiloto.toLowerCase() === nombreBusqueda);

            if (encontrado) {
                avisoBox.innerHTML = `‚ö†Ô∏è <b>¬°PARTICIPANTE YA REGISTRADO!</b><br>
                    Tiene asignado el <b>Ticket #${encontrado.nPapel.toString().padStart(3, '0')}</b>.<br>
                    <small>No necesita volver a firmar el documento f√≠sico.</small>`;
                avisoBox.style.display = 'block';
                
                firmaChk.checked = true; // Auto-check
                registroRecuperado = encontrado;
            } else {
                avisoBox.style.display = 'none';
                registroRecuperado = null;
            }
            fnValidar();
        });

        const fnValidar = () => { 
            btnAdd.disabled = !(nombreInput.value.trim() && firmaChk.checked); 
        };
        firmaChk.onchange = fnValidar;

        // --- L√ìGICA DE ACTUALIZACI√ìN DE INTERFAZ ---
        onValue(ref(db, 'copilotajes'), (snap) => {
            const data = snap.val() || {};
            document.getElementById('v-proximo-numero').innerText = ((data.ultimo_numero || 0) + 1).toString().padStart(3, '0');
            document.getElementById('count-tag').innerText = data.config_pilotos ? Object.keys(data.config_pilotos).length : 0;

            // RENDER COLA
            const tEspera = document.getElementById('tabla-espera');
            tEspera.innerHTML = "";
            if(data.espera) {
                Object.keys(data.espera).forEach(id => {
                    const item = data.espera[id];
                    const [pNombre, pCoche] = item.piloto.split(' | ');
                    const row = tEspera.insertRow();
                    row.innerHTML = `
                        <td><span class="n-papel-cola">${item.nPapel.toString().padStart(3, '0')}</span></td>
                        <td>
                            <strong style="font-size:1.1em; font-family:sans-serif">${item.copiloto}</strong>
                            <span class="time-tag">‚è± ${item.horaRegistro}</span><br>
                            <span style="font-size:0.85em; color:#bbb; font-family:sans-serif">${pNombre}</span> 
                            <span class="car-tag">| ${pCoche || ''}</span>
                        </td>
                        <td style="text-align:right">
                            <div class="ready-container">
                                <input type="checkbox" class="status-chk" ${item.enRecinto?'checked':''}>
                                <span class="${item.enRecinto ? 'label-dentro' : 'label-fuera'}">
                                    ${item.enRecinto ? 'DENTRO' : 'ESPERA'}
                                </span>
                            </div>
                        </td>
                    `;
                    row.querySelector('input').onchange = (e) => {
                        update(ref(db, `copilotajes/espera/${id}`), { enRecinto: e.target.checked });
                    };
                });
            }

            // RENDER HISTORIAL
            const tComp = document.getElementById('tabla-completados');
            tComp.innerHTML = "";
            if(data.completados) {
                Object.values(data.completados).sort((a,b) => b.nPapel - a.nPapel).slice(0, 5).forEach(item => {
                    const [pNombre, pCoche] = item.piloto.split(' | ');
                    const row = tComp.insertRow();
                    row.innerHTML = `
                        <td><span class="n-papel-cola" style="background:#444; color:#aaa;">${item.nPapel.toString().padStart(3, '0')}</span></td>
                        <td>
                            <strong style="font-family:sans-serif">${item.copiloto}</strong><br>
                            <small style="color:#666">${pNombre}</small> <small style="color:var(--accent)">[${pCoche || ''}]</small>
                        </td>
                        <td style="color:var(--green); font-size:0.8em; text-align:right; font-weight:bold;">üèÅ ${item.horaPista || '--:--'}</td>
                    `;
                });
            }
        });

        // --- BOT√ìN CONFIRMAR ---
        btnAdd.onclick = async () => {
            const pilotoSeleccionado = document.getElementById('c-piloto').value;
            const horaActual = new Date().toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'});

            if (registroRecuperado) {
                // Borrar de completados si estaba all√≠ para que no aparezca duplicado
                const snapC = await get(ref(db, 'copilotajes/completados'));
                if(snapC.exists()){
                    Object.entries(snapC.val()).forEach(([id, reg]) => {
                        if(reg.nPapel === registroRecuperado.nPapel) remove(ref(db, `copilotajes/completados/${id}`));
                    });
                }

                await push(ref(db, 'copilotajes/espera'), {
                    ...registroRecuperado,
                    piloto: pilotoSeleccionado,
                    enRecinto: true,
                    horaRegistro: horaActual
                });
            } else {
                const snapNum = await get(ref(db, 'copilotajes/ultimo_numero'));
                const num = (snapNum.val() || 0) + 1;
                
                await push(ref(db, 'copilotajes/espera'), {
                    nPapel: num,
                    copiloto: nombreInput.value.trim(),
                    piloto: pilotoSeleccionado,
                    enRecinto: false,
                    horaRegistro: horaActual
                });
                await set(ref(db, 'copilotajes/ultimo_numero'), num);
            }

            // Reset Formulario
            nombreInput.value = "";
            firmaChk.checked = false;
            avisoBox.style.display = 'none';
            registroRecuperado = null;
            fnValidar();
        };

        // --- GESTI√ìN DE PILOTOS (CSV) ---
        document.getElementById('csv-pilotos').onchange = (e) => {
            const r = new FileReader();
            r.onload = (ev) => {
                const lines = ev.target.result.split(/\r?\n/).filter(l => l.trim() !== "").slice(1);
                const obj = {};
                lines.forEach((l, i) => { 
                    const c = l.split(l.includes(';') ? ';' : ',');
                    if(c.length >= 3) {
                        obj[i] = `[#${c[0].trim()}] ${c[1].trim()} | ${c[2].trim()}`;
                    }
                });
                set(ref(db, 'copilotajes/config_pilotos'), obj);
            };
            r.readAsText(e.target.files[0]);
        };

        onValue(ref(db, 'copilotajes/config_pilotos'), (snap) => {
            const sel = document.getElementById('c-piloto');
            sel.innerHTML = '';
            if(snap.exists()){
                Object.values(snap.val()).forEach(p => {
                    let opt = document.createElement('option');
                    opt.value = p; opt.innerText = p;
                    sel.appendChild(opt);
                });
            }
        });

        // --- EXPORTAR Y REINICIAR ---
        document.getElementById('btn-reset').onclick = async () => {
            const snap = await get(ref(db, 'copilotajes'));
            if (!snap.exists()) return;
            const data = snap.val();
            let listado = [];
            if(data.espera) Object.values(data.espera).forEach(v => listado.push({...v, estado: 'PENDIENTE'}));
            if(data.completados) Object.values(data.completados).forEach(v => listado.push({...v, estado: 'COMPLETADO'}));
            listado.sort((a,b) => a.nPapel - b.nPapel);

            let csv = "N¬∫ TICKET,ESTADO,COPILOTO,PILOTO,HORA REGISTRO\n";
            listado.forEach(v => csv += `${v.nPapel},${v.estado},${v.copiloto},${v.piloto},${v.horaRegistro}\n`);

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Cierre_Evento_${new Date().toLocaleDateString()}.csv`;
            a.click();

            setTimeout(() => {
                if(confirm("¬øBORRAR TODO EL EVENTO?")) remove(ref(db, 'copilotajes'));
            }, 500);
        };

        onValue(ref(db, 'copilotajes/nombre_evento'), s => document.getElementById('nombre-evento').value = s.val() || "");
        document.getElementById('nombre-evento').onchange = (e) => set(ref(db, 'copilotajes/nombre_evento'), e.target.value);
    </script>
</body>
</html>








