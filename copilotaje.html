<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOG√çSTICA TAXI DRIFT</title>
    <style>
        :root { --accent: #ffcc00; --bg: #111; --card: rgba(25, 25, 25, 0.95); --green: #28a745; --red: #ff0000; --blue: #007bff; }
        
        body { 
            background-image: url('Fibra3.png'); 
            background-repeat: repeat; 
            color: #fff; 
            font-family: 'Arial Black', Gadget, sans-serif; 
            padding: 10px; margin: 0; 
        }
        
        .header-top { 
            display: flex; flex-direction: column; align-items: center; 
            padding: 15px; background: rgba(0,0,0,0.9); border-radius: 12px; 
            border: 2px solid #333; margin-bottom: 15px; gap: 12px; 
        }
        .brand { color: var(--red); font-size: 2.5em; font-weight: 900; letter-spacing: -1px; text-shadow: 2px 2px 0 #000; }
        
        .event-name-input { 
            background: transparent; border: none; border-bottom: 2px solid #444; 
            color: var(--accent); font-size: 1.2em; text-align: center; width: 90%; 
            font-family: 'Arial Black', sans-serif; outline: none;
        }

        .controls-row { display: flex; width: 100%; gap: 8px; justify-content: flex-end; }
        .btn-mini { background: #222; color: #ccc; border: 1px solid #444; padding: 10px 14px; border-radius: 6px; font-size: 0.75em; text-transform: uppercase; cursor: pointer; font-family: sans-serif; font-weight: bold; }
        .btn-reset { color: var(--red); border-color: #522; }

        .main-card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #444; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .input-huge { width: 100%; height: 60px; background: #000; border: 1px solid #444; border-radius: 10px; color: #fff; font-size: 1.2em; padding: 0 15px; box-sizing: border-box; margin-bottom: 15px; font-family: sans-serif; }
        
        .doc-box { background: #000; border: 1px solid var(--accent); border-radius: 10px; padding: 10px; text-align: center; margin-bottom: 15px; }
        .doc-box small { display: block; font-size: 0.6em; color: #666; font-family: sans-serif; margin-bottom: 2px; }
        .doc-box b { font-size: 2.8em; font-family: monospace; color: var(--accent); }

        .chk-massive { width: 100%; height: 65px; background: #1a1a1a; border-radius: 10px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; gap: 15px; cursor: pointer; margin-bottom: 20px; }
        .chk-massive input { transform: scale(2); }

        .btn-add-massive { width: 100%; height: 75px; background: var(--green); color: #fff; border: none; border-radius: 12px; font-weight: 900; font-size: 1.3em; text-transform: uppercase; cursor: pointer; box-shadow: 0 6px 0 #155d27; }
        .btn-add-massive:disabled { background: #333; color: #555; box-shadow: none; opacity: 0.5; }

        .table-card { background: rgba(0,0,0,0.95); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid #444; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 15px 5px; border-bottom: 1px solid #222; }
        
        .n-papel-cola { color: #000; background: var(--accent); font-weight: 900; font-family: monospace; font-size: 1.4em; padding: 5px 10px; border-radius: 5px; display: inline-block; min-width: 45px; text-align: center; }
        .time-tag { font-size: 0.7em; color: var(--blue); font-family: sans-serif; font-weight: bold; margin-left: 5px; }
        .car-tag { color: var(--accent); font-weight: bold; font-size: 0.85em; text-transform: uppercase; font-family: sans-serif; }
        
        .ready-container { display: flex; flex-direction: column; align-items: center; font-size: 0.65em; font-weight: bold; min-width: 100px; text-align: center; }
        .status-chk { transform: scale(2.2); cursor: pointer; margin-bottom: 8px; }
        .label-espera { color: #666; }
        .label-dentro { color: var(--green); }
    </style>
</head>
<body>

    <div class="header-top">
        <span class="brand">TAXI DRIFT</span>
        <input type="text" id="nombre-evento" class="event-name-input" placeholder="NOMBRE DEL EVENTO">
        <div class="controls-row">
            <button class="btn-mini" onclick="document.getElementById('csv-pilotos').click()">CARGAR PILOTOS (<span id="count-tag">0</span>)</button>
            <button class="btn-mini btn-reset" id="btn-reset">REINICIAR EVENTO</button>
        </div>
        <input type="file" id="csv-pilotos" hidden accept=".csv">
    </div>

    <div class="main-card">
        <input type="text" id="c-nombre" class="input-huge" placeholder="NOMBRE DEL PARTICIPANTE">
        <select id="c-piloto" class="input-huge"></select>
        <div class="doc-box">
            <small>N¬∫ DOCUMENTO CORRELATIVO</small>
            <b id="v-proximo-numero">001</b>
        </div>
        <label class="chk-massive">
            <input type="checkbox" id="c-firma"> 
            <span style="font-family: sans-serif; font-weight: bold;">RESPONSABILIDAD FIRMADA</span>
        </label>
        <button id="btn-add" class="btn-add-massive" disabled>CONFIRMAR REGISTRO</button>
    </div>

    <div class="table-card">
        <div style="font-size:0.8em; color:var(--accent); font-weight:bold; margin-bottom:15px; text-transform: uppercase;">üìã Cola de Acceso</div>
        <table id="tabla-espera"></table>
    </div>

    <div class="table-card">
        <div style="font-size:0.8em; color:var(--green); font-weight:bold; margin-bottom:15px; text-transform: uppercase;">üèÅ √öltimos en Pista</div>
        <table id="tabla-completados"></table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let pilotosArray = [];

        onValue(ref(db, 'copilotajes'), (snap) => {
            const data = snap.val() || {};
            document.getElementById('v-proximo-numero').innerText = ((data.ultimo_numero || 0) + 1).toString().padStart(3, '0');
            document.getElementById('count-tag').innerText = data.config_pilotos ? Object.keys(data.config_pilotos).length : 0;

            const todosViajes = [...Object.values(data.espera || {}), ...Object.values(data.completados || {})];
            const conteo = {};
            todosViajes.forEach(v => { conteo[v.piloto] = (conteo[v.piloto] || 0) + 1; });

            if(pilotosArray.length > 0) {
                let sugerido = pilotosArray[0];
                let min = conteo[sugerido] || 0;
                pilotosArray.forEach(p => {
                    if((conteo[p] || 0) < min) { min = (conteo[p] || 0); sugerido = p; }
                });
                if(document.activeElement.id !== 'c-piloto') document.getElementById('c-piloto').value = sugerido;
            }

            // RENDER COLA
            const tEspera = document.getElementById('tabla-espera');
            tEspera.innerHTML = "";
            if(data.espera) {
                Object.keys(data.espera).forEach(id => {
                    const item = data.espera[id];
                    const [pNombre, pCoche] = item.piloto.split(' | ');
                    const row = tEspera.insertRow();
                    row.innerHTML = `
                        <td><span class="n-papel-cola">${item.nPapel.toString().padStart(3, '0')}</span></td>
                        <td>
                            <strong style="font-size:1.1em; font-family:sans-serif">${item.copiloto}</strong>
                            <span class="time-tag">‚è± ${item.horaRegistro}</span><br>
                            <span style="font-size:0.85em; color:#bbb; font-family:sans-serif">${pNombre}</span> 
                            <span class="car-tag">| ${pCoche || ''}</span>
                        </td>
                        <td style="text-align:right">
                            <div class="ready-container">
                                <input type="checkbox" class="status-chk" ${item.enRecinto?'checked':''}>
                                <span class="${item.enRecinto ? 'label-dentro' : 'label-espera'}">
                                    ${item.enRecinto ? 'DENTRO' : 'FUERA'}
                                </span>
                            </div>
                        </td>
                    `;
                    row.querySelector('input').onchange = (e) => {
                        update(ref(db, `copilotajes/espera/${id}`), { enRecinto: e.target.checked });
                    };
                });
            }

            // RENDER HISTORIAL
            const tComp = document.getElementById('tabla-completados');
            tComp.innerHTML = "";
            if(data.completados) {
                Object.values(data.completados).sort((a,b) => b.nPapel - a.nPapel).slice(0, 5).forEach(item => {
                    const [pNombre, pCoche] = item.piloto.split(' | ');
                    const row = tComp.insertRow();
                    row.innerHTML = `
                        <td><span class="n-papel-cola" style="background:#444; color:#aaa;">${item.nPapel.toString().padStart(3, '0')}</span></td>
                        <td>
                            <strong style="font-family:sans-serif">${item.copiloto}</strong><br>
                            <small style="color:#666">${pNombre}</small> <small style="color:var(--accent)">[${pCoche || ''}]</small>
                        </td>
                        <td style="color:var(--green); font-size:0.8em; text-align:right; font-weight:bold;">üèÅ ${item.horaPista}</td>
                    `;
                });
            }
        });

        // CARGA DE PILOTOS
        document.getElementById('csv-pilotos').onchange = (e) => {
            const r = new FileReader();
            r.onload = (ev) => {
                const lines = ev.target.result.split(/\r?\n/).filter(l => l.trim() !== "").slice(1);
                const obj = {};
                lines.forEach((l, i) => { 
                    const c = l.split(l.includes(';') ? ';' : ',');
                    if(c.length >= 3) obj[i] = `${c[1].trim()} | ${c[2].trim()}`;
                });
                set(ref(db, 'copilotajes/config_pilotos'), obj);
            };
            r.readAsText(e.target.files[0]);
        };

        onValue(ref(db, 'copilotajes/config_pilotos'), (snap) => {
            const sel = document.getElementById('c-piloto');
            sel.innerHTML = ''; pilotosArray = [];
            if(snap.exists()){
                Object.values(snap.val()).forEach(p => {
                    pilotosArray.push(p);
                    let opt = document.createElement('option');
                    opt.value = p; opt.innerText = p;
                    sel.appendChild(opt);
                });
            }
        });

        const btn = document.getElementById('btn-add');
        const fnValidar = () => { btn.disabled = !(document.getElementById('c-nombre').value.trim() && document.getElementById('c-firma').checked); };
        document.getElementById('c-nombre').oninput = fnValidar;
        document.getElementById('c-firma').onchange = fnValidar;

        btn.onclick = async () => {
            const snapNum = await get(ref(db, 'copilotajes/ultimo_numero'));
            const num = (snapNum.val() || 0) + 1;
            await push(ref(db, 'copilotajes/espera'), {
                nPapel: num, copiloto: document.getElementById('c-nombre').value.trim(),
                piloto: document.getElementById('c-piloto').value, enRecinto: false,
                horaRegistro: new Date().toLocaleTimeString('es-ES', {hour:'2-digit', minute:'2-digit'})
            });
            await set(ref(db, 'copilotajes/ultimo_numero'), num);
            document.getElementById('c-nombre').value = ""; document.getElementById('c-firma').checked = false; fnValidar();
        };

        // EXPORTAR Y REINICIAR
        document.getElementById('btn-reset').onclick = async () => {
            const snap = await get(ref(db, 'copilotajes'));
            if (!snap.exists()) return;
            
            const data = snap.val();
            const nombreEvento = data.nombre_evento || "EVENTO_TAXI_DRIFT";
            
            // Combinar espera y completados para el CSV
            let listado = [];
            if(data.espera) Object.values(data.espera).forEach(v => listado.push({...v, estado: 'PENDIENTE'}));
            if(data.completados) Object.values(data.completados).forEach(v => listado.push({...v, estado: 'COMPLETADO'}));
            
            listado.sort((a,b) => a.nPapel - b.nPapel);

            // Crear contenido CSV
            let csvContent = "N¬∫ TICKET,ESTADO,COPILOTO,PILOTO,COCHE,HORA REGISTRO,HORA PISTA\n";
            listado.forEach(v => {
                const [pNom, pCoch] = v.piloto.split(' | ');
                csvContent += `${v.nPapel},${v.estado},${v.copiloto},${pNom},${pCoch || ''},${v.horaRegistro},${v.horaPista || '-'}\n`;
            });

            // Descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${nombreEvento.replace(/\s+/g, '_')}_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Confirmaci√≥n de borrado
            setTimeout(() => {
                if(confirm("CSV EXPORTADO. ¬øDeseas borrar todos los datos de la nube para empezar un nuevo evento?")) {
                    remove(ref(db, 'copilotajes'));
                }
            }, 500);
        };

        onValue(ref(db, 'copilotajes/nombre_evento'), s => document.getElementById('nombre-evento').value = s.val() || "");
        document.getElementById('nombre-evento').onchange = (e) => set(ref(db, 'copilotajes/nombre_evento'), e.target.value);
    </script>
</body>
</html>


