<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRIFT SHOW LIVE - P칔BLICO</title>
    <style>
        body { 
            margin: 0; 
            padding: 15px; 
            font-family: sans-serif; 
            color: white; 
            text-align: center;
            /* Fondo en mosaico repetido */
            background-image: url('logo2.jpg');
            background-repeat: repeat;
            background-size: 100px; /* Ajusta el tama침o del logo en el mosaico */
        }

        /* Marco centrado transparente */
        .contenedor-principal {
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #ffcc00;
            border-radius: 20px;
            padding: 20px;
            max-width: 500px;
            margin: 20px auto;
            min-height: 200px;
        }

        #banner-estado {
            padding: 15px;
            font-weight: bold;
            border-radius: 10px;
            margin-bottom: 20px;
            text-transform: uppercase;
            font-size: 1.2em;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* Estilo de los bloques de votaci칩n */
        .voto-card {
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 12px;
            border-left: 5px solid #ffcc00;
        }

        .nombre-piloto { font-weight: bold; font-size: 1.1em; color: #ffcc00; }
        .coche-piloto { font-size: 0.85em; color: #bbb; margin-bottom: 10px; }

        /* Iconos de votos */
        .v-btns { 
            display: flex; 
            justify-content: space-around; 
            font-size: 2.5em; 
            margin-top: 5px;
        }

        .btn-voto {
            cursor: pointer;
            filter: grayscale(100%); /* Blanco y negro por defecto */
            transition: 0.3s;
            opacity: 0.5;
        }

        .btn-voto.seleccionado {
            filter: grayscale(0%); /* Color al seleccionar */
            opacity: 1;
            transform: scale(1.2);
        }

        .timer-alerta {
            color: #ff4444;
            font-weight: bold;
            margin-top: 10px;
            animation: parpadeo 1s infinite;
        }

        @keyframes parpadeo { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="contenedor-principal">
        <div id="banner-estado">CONECTANDO...</div>

        <div id="seccion-votos" style="display:none">
            <div id="lista-votables"></div>
            <div id="cuenta-atras" class="timer-alerta"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let misVotos = {}; // Para permitir cambiar el voto

        // 1. Escuchar Estado de Pista
        onValue(ref(db, 'estado_pista'), s => {
            const p = s.val();
            const b = document.getElementById('banner-estado');
            if(p) {
                b.innerText = p.mensaje;
                b.style.background = p.color;
            }
        });

        // 2. Escuchar Votaci칩n Activa
        onValue(ref(db, 'votacion_activa'), s => {
            const v = s.val();
            const divVotos = document.getElementById('seccion-votos');
            const lista = document.getElementById('lista-votables');
            const timerDiv = document.getElementById('cuenta-atras');

            if(v && v.activa) {
                divVotos.style.display = 'block';
                
                // Si el objeto de votables ha cambiado o es nuevo, dibujamos
                // Esperamos que el Master env칤e 'items' (pilotos individuales y batalla)
                if (v.items) {
                    lista.innerHTML = '';
                    Object.entries(v.items).forEach(([id, data]) => {
                        const card = document.createElement('div');
                        card.className = 'voto-card';
                        
                        // Diferenciar si es Batalla o Piloto
                        const nombreMostrar = id === 'BATALLA' ? "游댠 BATALLA " + v.dorsal : data.nombre;
                        const cocheMostrar = id === 'BATALLA' ? "" : (data.coche || "");

                        card.innerHTML = `
                            <div class="nombre-piloto">${nombreMostrar}</div>
                            <div class="coche-piloto">${cocheMostrar}</div>
                            <div class="v-btns">
                                <span class="btn-voto ${misVotos[id] === 'aplausos' ? 'seleccionado' : ''}" onclick="enviarVoto('${id}', 'aplausos')">游녪</span>
                                <span class="btn-voto ${misVotos[id] === 'up' ? 'seleccionado' : ''}" onclick="enviarVoto('${id}', 'up')">游녨</span>
                                <span class="btn-voto ${misVotos[id] === 'down' ? 'seleccionado' : ''}" onclick="enviarVoto('${id}', 'down')">游녩</span>
                            </div>
                        `;
                        lista.appendChild(card);
                    });
                }

                // Mostrar cuenta atr치s si el Master la activa (timer > 0)
                if(v.timer > 0) {
                    timerDiv.innerText = `CERRANDO EN ${v.timer}s...`;
                } else {
                    timerDiv.innerText = "";
                }

            } else {
                divVotos.style.display = 'none';
                misVotos = {}; // Resetear mis votos al cerrar
            }
        });

        window.enviarVoto = (idVotable, tipoVoto) => {
            // L칩gica para poder cambiar el voto:
            // Si ya vot칩 algo en este piloto, restamos el anterior y sumamos el nuevo
            const actualizaciones = {};
            const anteriorVoto = misVotos[idVotable];

            if (anteriorVoto === tipoVoto) return; // Ya est치 seleccionado

            if (anteriorVoto) {
                // Restar el voto anterior en la base de datos
                actualizaciones[`votacion_activa/items/${idVotable}/${anteriorVoto}`] = increment(-1);
            }

            // Sumar el nuevo voto
            actualizaciones[`votacion_activa/items/${idVotable}/${tipoVoto}`] = increment(1);
            
            update(ref(db), actualizaciones);
            misVotos[idVotable] = tipoVoto;
            
            // Forzar refresco visual de los iconos seleccionados
            document.querySelectorAll(`.voto-card`).forEach(() => {
                // El onValue se encargar치 de redibujar con las clases correctas
            });
        };
    </script>
</body>
</html>
