<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRIFT SHOW LIVE - P√öBLICO</title>
    <style>
        body { 
            margin: 0; padding: 15px; font-family: sans-serif; color: white; text-align: center;
            background-image: url('logo2.jpg'); background-repeat: repeat; background-size: 200px; 
        }

        .contenedor-principal {
            background: rgba(0, 0, 0, 0.97); 
            border: 2px solid #ffcc00; border-radius: 20px;
            padding: 20px; max-width: 500px; margin: 20px auto; min-height: 200px;
            box-shadow: 0 0 20px rgba(0,0,0,1);
        }

        #banner-estado {
            padding: 15px; font-weight: bold; border-radius: 10px; margin-bottom: 20px;
            text-transform: uppercase; font-size: 1.2em; border: 1px solid rgba(255,255,255,0.2);
        }

        .voto-card {
            background: rgba(255, 255, 255, 0.2); 
            margin-bottom: 15px; padding: 15px;
            border-radius: 12px; border-left: 5px solid #ffcc00;
        }

        .voto-card.es-batalla {
            border-left: 5px solid #ff4444;
            background: rgba(255, 0, 0, 0.2);
        }
        .voto-card.es-batalla .nombre-piloto { color: #ff4444; }

        .nombre-piloto { font-weight: bold; font-size: 1.2em; color: #ffcc00; text-transform: uppercase; }
        .coche-piloto { font-size: 0.9em; color: #aaa; margin-bottom: 10px; font-style: italic; }

        .v-btns { display: flex; justify-content: space-around; font-size: 3em; margin-top: 10px; }

        .btn-voto {
            cursor: pointer; filter: grayscale(100%); transition: 0.2s; opacity: 0.3;
        }

        .btn-voto.seleccionado {
            filter: grayscale(0%) !important; opacity: 1 !important; transform: scale(1.2);
        }

        .timer-alerta { color: #ff4444; font-weight: bold; margin-top: 15px; font-size: 1.4em; }
    </style>
</head>
<body>

    <div class="contenedor-principal">
        <div id="banner-estado">CONECTANDO...</div>
        <div id="seccion-votos" style="display:none">
            <div id="lista-votables"></div>
            <div id="cuenta-atras" class="timer-alerta"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let misVotos = {}; 
        let currentDorsalGlobal = "";

        onValue(ref(db, 'estado_pista'), s => {
            const p = s.val();
            const b = document.getElementById('banner-estado');
            if(p) { 
                // Eliminamos el emoji si viene del Master o de Pista
                b.innerText = p.mensaje.replace('üèéÔ∏è ', ''); 
                b.style.background = p.color; 
            }
        });

        onValue(ref(db, 'votacion_activa'), s => {
            const v = s.val();
            const divVotos = document.getElementById('seccion-votos');
            const lista = document.getElementById('lista-votables');
            const timerDiv = document.getElementById('cuenta-atras');

            if(v && v.activa) {
                if (currentDorsalGlobal !== v.dorsal) {
                    misVotos = {};
                    currentDorsalGlobal = v.dorsal;
                }
                divVotos.style.display = 'block';
                if (lista.innerHTML === "") {
                    if (v.items) {
                        Object.entries(v.items).forEach(([id, data]) => {
                            crearTarjetaUI(id, data.nombre, data.coche || "", lista);
                        });
                    } else if (v.dorsal) {
                        crearTarjetaUI(v.dorsal, v.info || ("DORSAL " + v.dorsal), "", lista);
                    }
                }
                timerDiv.innerText = (v.timer > 0) ? `¬°CIERRE EN ${v.timer}s!` : "";
            } else {
                divVotos.style.display = 'none';
                lista.innerHTML = "";
                misVotos = {};
                currentDorsalGlobal = "";
            }
        });

        function crearTarjetaUI(id, nombre, coche, contenedor) {
            const card = document.createElement('div');
            card.className = 'voto-card' + (id === 'BATALLA' ? ' es-batalla' : '');
            card.id = "card-" + id;
            card.innerHTML = `
                <div class="nombre-piloto">${nombre}</div>
                <div class="coche-piloto">${coche}</div>
                <div class="v-btns">
                    <span class="btn-voto v-ap ${misVotos[id] === 'ap' ? 'seleccionado' : ''}" onclick="enviarVoto('${id}', 'ap')">üëè</span>
                    <span class="btn-voto v-up ${misVotos[id] === 'up' ? 'seleccionado' : ''}" onclick="enviarVoto('${id}', 'up')">üëç</span>
                    <span class="btn-voto v-dw ${misVotos[id] === 'dw' ? 'seleccionado' : ''}" onclick="enviarVoto('${id}', 'dw')">üëé</span>
                </div>
            `;
            contenedor.appendChild(card);
        }

        window.enviarVoto = (idVotable, tipoVoto) => {
            if (misVotos[idVotable] === tipoVoto) return;
            const updates = {};
            const anterior = misVotos[idVotable];
            if (anterior) {
                updates[`votacion_activa/items/${idVotable}/${anterior}`] = increment(-1);
            }
            updates[`votacion_activa/items/${idVotable}/${tipoVoto}`] = increment(1);
            update(ref(db), updates);
            misVotos[idVotable] = tipoVoto;
            const card = document.getElementById("card-" + idVotable);
            if (card) {
                card.querySelectorAll('.btn-voto').forEach(b => b.classList.remove('seleccionado'));
                card.querySelector('.v-' + tipoVoto).classList.add('seleccionado');
            }
        };
    </script>
</body>
</html>
