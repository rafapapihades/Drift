<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>DRIFT SHOW - VOTA!</title>
Â  Â  <style>
Â  Â  Â  Â  body {Â 
Â  Â  Â  Â  Â  Â  background-image: url('logo2.jpg');Â 
Â  Â  Â  Â  Â  Â  background-repeat: repeat;Â 
Â  Â  Â  Â  Â  Â  background-size: 195px;Â 
Â  Â  Â  Â  Â  Â  background-color: #000;Â 
Â  Â  Â  Â  Â  Â  color: #fff;Â 
Â  Â  Â  Â  Â  Â  font-family: sans-serif;Â 
Â  Â  Â  Â  Â  Â  margin: 0;Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .overlay {Â 
Â  Â  Â  Â  Â  Â  min-height: 100vh;Â 
Â  Â  Â  Â  Â  Â  padding: 15px;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.4);
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }

Â  Â  Â  Â  .glass-panel {
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.85);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  -webkit-backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 480px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* DISEÃ‘O DE BLOQUE DE VOTACIÃ“N */
Â  Â  Â  Â  .voto-block {
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.05);
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .voto-block.batalla {
Â  Â  Â  Â  Â  Â  background: linear-gradient(145deg, #001a33, #000);
Â  Â  Â  Â  Â  Â  border: 1px solid #007bff;
Â  Â  Â  Â  }
Â  Â  Â  Â  .voto-title {
Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  color: #ffcc00;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  }
Â  Â  Â  Â  .voto-block.batalla .voto-title { color: #00bfff; }

Â  Â  Â  Â  .v-btn { font-size: 3.5em; filter: grayscale(1); margin: 0 10px; transition: 0.2s; cursor: pointer; display: inline-block; }
Â  Â  Â  Â  .v-act { filter: grayscale(0) !important; transform: scale(1.2); text-shadow: 0 0 15px rgba(255,255,0,0.5); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #timer-box { color: #ff4444; font-weight: bold; font-size: 1.4em; margin-top: 10px; height: 30px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .rank-card {Â 
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.05);Â 
Â  Â  Â  Â  Â  Â  padding: 12px; border-radius: 8px; width: 100%; margin: 8px 0;Â 
Â  Â  Â  Â  Â  Â  border-left: 4px solid #ffcc00; display: flex; justify-content: space-between; text-align: left;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="overlay">
Â  Â  Â  Â  <div class="glass-panel">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="ui-show" style="display:none; width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <h1 id="s-mensaje" style="font-size: 2.2em; margin: 0 0 15px 0; text-shadow: 2px 2px 4px #000;"></h1>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="contenedor-votos"></div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="timer-box"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="ui-esc" style="display:none; width: 100%">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color:#ffcc00; font-size: 1.8em; margin-top: 0;">RANKING dB</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="l-db"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color:#ffcc00; font-size: 1.8em; margin-top: 20px;">RANKING SONORIDAD</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="l-hz"></div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
Â  Â  Â  Â  import { getDatabase, ref, onValue, update, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
Â  Â  Â  Â Â 
Â  Â  Â  Â  const db = getDatabase(initializeApp({ databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" }));

Â  Â  Â  Â  let misVotos = {}; // Guardamos el voto para cada ID { "12": "up", "BATALLA": "aplausos" }

Â  Â  Â  Â  onValue(ref(db, 'modo_actual'), s => {
Â  Â  Â  Â  Â  Â  const m = s.val() || 'tab-show';
Â  Â  Â  Â  Â  Â  document.getElementById('ui-show').style.display = m==='tab-show'?'block':'none';
Â  Â  Â  Â  Â  Â  document.getElementById('ui-esc').style.display = m==='tab-esc'?'block':'none';
Â  Â  Â  Â  });

Â  Â  Â  Â  onValue(ref(db, 'estado_pista'), s => {
Â  Â  Â  Â  Â  Â  const e = s.val();
Â  Â  Â  Â  Â  Â  const msg = document.getElementById('s-mensaje');
Â  Â  Â  Â  Â  Â  msg.innerText = e?.mensaje || "";
Â  Â  Â  Â  Â  Â  msg.style.color = e?.color || "white";
Â  Â  Â  Â  });

Â  Â  Â  Â  onValue(ref(db, 'votacion_activa'), s => {
Â  Â  Â  Â  Â  Â  const v = s.val();
Â  Â  Â  Â  Â  Â  const container = document.getElementById('contenedor-votos');
Â  Â  Â  Â  Â  Â  const timerDisplay = document.getElementById('timer-box');

Â  Â  Â  Â  Â  Â  if (v?.activa && v.items) {
Â  Â  Â  Â  Â  Â  Â  Â  // Solo regenerar el HTML si cambia el nÃºmero de items
Â  Â  Â  Â  Â  Â  Â  Â  const idsActuales = Object.keys(v.items).join(',');
Â  Â  Â  Â  Â  Â  Â  Â  if (container.dataset.currentIds !== idsActuales) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const id_voto in v.items) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const esBatalla = id_voto === "BATALLA";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = v.items[id_voto];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const block = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  block.className = `voto-block ${esBatalla ? 'batalla' : ''}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  block.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="voto-title">${item.nombre}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="emoji-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="v-btn" id="btn-${id_voto}-ap" onclick="votar('${id_voto}', 'ap')">ğŸ‘</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="v-btn" id="btn-${id_voto}-up" onclick="votar('${id_voto}', 'up')">ğŸ‘</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="v-btn" id="btn-${id_voto}-dw" onclick="votar('${id_voto}', 'dw')">ğŸ‘</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(block);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.dataset.currentIds = idsActuales;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actualizarIconos();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (v.timer > 0) timerDisplay.innerText = `CIERRE EN: ${v.timer}...`;
Â  Â  Â  Â  Â  Â  Â  Â  else timerDisplay.innerText = "";

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = "";
Â  Â  Â  Â  Â  Â  Â  Â  container.dataset.currentIds = "";
Â  Â  Â  Â  Â  Â  Â  Â  timerDisplay.innerText = "";
Â  Â  Â  Â  Â  Â  Â  Â  misVotos = {};
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  window.votar = (id_voto, tipo) => {
Â  Â  Â  Â  Â  Â  // Si ya votÃ³ esto mismo en este bloque, no hacer nada
Â  Â  Â  Â  Â  Â  if (misVotos[id_voto] === tipo) return;

Â  Â  Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  Â  Â  // Si ya habÃ­a votado algo en este bloque, restamos el voto anterior
Â  Â  Â  Â  Â  Â  if (misVotos[id_voto]) {
Â  Â  Â  Â  Â  Â  Â  Â  updates[`votacion_activa/items/${id_voto}/${misVotos[id_voto]}`] = increment(-1);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Sumamos el nuevo voto
Â  Â  Â  Â  Â  Â  updates[`votacion_activa/items/${id_voto}/${tipo}`] = increment(1);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  update(ref(db), updates);
Â  Â  Â  Â  Â  Â  misVotos[id_voto] = tipo;
Â  Â  Â  Â  Â  Â  actualizarIconos();
Â  Â  Â  Â  };

Â  Â  Â  Â  function actualizarIconos() {
Â  Â  Â  Â  Â  Â  // Quitamos la clase activa de todos
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.v-btn').forEach(b => b.classList.remove('v-act'));
Â  Â  Â  Â  Â  Â  // La ponemos solo en los que el usuario ha marcado
Â  Â  Â  Â  Â  Â  for (const id_voto in misVotos) {
Â  Â  Â  Â  Â  Â  Â  Â  const tipo = misVotos[id_voto];
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.getElementById(`btn-${id_voto}-${tipo}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (btn) btn.classList.add('v-act');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  onValue(ref(db, 'ranking_escapes'), s => {
Â  Â  Â  Â  Â  Â  if(!s.exists()) return;
Â  Â  Â  Â  Â  Â  const data = Object.values(s.val());
Â  Â  Â  Â  Â  Â  const render = (arr, tId, sFn, u) => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(tId).innerHTML = arr.sort(sFn).slice(0,10).map(p =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `<div class="rank-card"><span><b>${p.dorsal}</b> ${p.piloto}<br><small>${p.coche}</small></span><b>${p[u.toLowerCase()==='db'?'db':'hz']}${u}</b></div>`).join('');
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  render([...data], 'l-db', (a,b)=>b.db-a.db, 'dB');
Â  Â  Â  Â  Â  Â  render([...data], 'l-hz', (a,b)=>a.hz-b.hz, 'Hz');
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
