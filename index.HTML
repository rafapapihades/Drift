<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOTA - DRIFT SHOW</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 15px; text-align: center; }
        
        /* BANNER DE ESTADO DE PISTA */
        #pista-status {
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.4em;
            margin-bottom: 20px;
            text-transform: uppercase;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .container { max-width: 600px; margin: 0 auto; }

        /* RECUADROS DE VOTACI칍N */
        .piloto-card {
            background: #1a1a1a; /* Menos transparencia, m치s s칩lido */
            border: 2px solid #333;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: 0.3s;
        }

        /* COLOR ESPECIAL PARA BATALLAS */
        .es-batalla {
            border-color: #ff4444 !important;
            background: #2a0505 !important; /* Fondo rojizo oscuro s칩lido */
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.4);
        }

        .nombre { font-size: 1.6em; font-weight: bold; margin-bottom: 15px; color: #ffcc00; text-transform: uppercase; }
        .es-batalla .nombre { color: #ff4444; }

        .btn-voto {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .v {
            padding: 20px 10px;
            border-radius: 10px;
            border: none;
            color: #fff;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: 0.1s;
        }

        .v:active { transform: scale(0.9); }
        .ap { background: #444; }
        .up { background: #008000; }
        .dw { background: #cc0000; }

        .timer {
            background: #ff4444;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="pista-status">CARGANDO ESTADO...</div>
        <div id="voto-area"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const db = getDatabase(initializeApp({ databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" }));

        // Escuchar estado de pista
        onValue(ref(db, 'estado_pista'), s => {
            const d = s.val();
            if(d) {
                const b = document.getElementById('pista-status');
                b.innerText = d.mensaje;
                b.style.backgroundColor = d.color;
                b.style.color = (d.color === '#ffcc00') ? 'black' : 'white';
            }
        });

        // Escuchar votaci칩n activa
        onValue(ref(db, 'votacion_activa'), snap => {
            const v = snap.val();
            const area = document.getElementById('voto-area');
            
            if (!v || !v.activa) {
                area.innerHTML = "<h2 style='color:#666; margin-top:50px;'>ESPERANDO SIGUIENTE COCHE...</h2>";
                return;
            }

            let html = v.timer > 0 ? `<div class="timer">CIERRE EN: ${v.timer}s</div>` : "";

            if (v.items) {
                html += Object.entries(v.items).map(([id, data]) => {
                    const claseBatalla = id === 'BATALLA' ? 'es-batalla' : '';
                    const nombreDisplay = id === 'BATALLA' ? "游댠 BATALLA 游댠" : `#${id} ${data.nombre}`;
                    
                    return `
                        <div class="piloto-card ${claseBatalla}">
                            <div class="nombre">${nombreDisplay}</div>
                            <div class="btn-voto">
                                <button class="v ap" onclick="votar('${id}', 'ap')">游녪</button>
                                <button class="v up" onclick="votar('${id}', 'up')">游녨</button>
                                <button class="v dw" onclick="votar('${id}', 'dw')">游녩</button>
                            </div>
                        </div>
                    `;
                }).join('');
                area.innerHTML = html;
            }
        });

        window.votar = (id, tipo) => {
            if (navigator.vibrate) navigator.vibrate(40);
            const path = `votacion_activa/items/${id}/${tipo}`;
            update(ref(db), { [path]: increment(1) });
            
            // Efecto visual simple al votar
            event.target.style.opacity = "0.5";
            setTimeout(() => { event.target.style.opacity = "1"; }, 100);
        };
    </script>
</body>
</html>
