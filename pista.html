<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DRIFT SHOW - COMISARIOS</title>
    <style>
        * { box-sizing: border-box; }
        body { background: #000; color: #fff; font-family: sans-serif; margin: 0; padding: 15px; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        .header { text-align: center; padding: 10px 0; border-bottom: 1px solid #333; margin-bottom: 15px; }
        .header h1 { margin: 0; font-size: 1.2em; color: #888; letter-spacing: 2px; }

        /* ESTADO ACTUAL */
        .status-banner {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            border: 2px solid #333;
            transition: 0.3s;
        }

        /* BOTONES GRANDES */
        .controls { display: flex; flex-direction: column; gap: 15px; flex: 1; }
        
        .btn-comisario {
            flex: 1;
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 1.8em;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s, opacity 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .btn-comisario:active { transform: scale(0.96); }
        
        /* ESTILOS ESPEC칈FICOS */
        .btn-libre { background: #008000; }
        .btn-obs { background: #ffcc00; color: #000; }
        .btn-acc { background: #cc0000; }

        /* EFECTO SELECCIONADO */
        .active-now {
            outline: 5px solid white;
            box-shadow: 0 0 30px rgba(255,255,255,0.4);
            z-index: 2;
        }
        
        .inactive { opacity: 0.3; }

    </style>
</head>
<body>

    <div class="header">
        <h1>CONTROL DE PISTA</h1>
    </div>

    <div id="banner" class="status-banner">CARGANDO...</div>

    <div class="controls">
        <button id="btn-libre" class="btn-comisario btn-libre" onclick="enviarEstado('游릭 PISTA LIBRE', 'green', 'btn-libre')">
            PISTA LIBRE
        </button>
        
        <button id="btn-obs" class="btn-comisario btn-obs" onclick="enviarEstado('丘멆잺 OBST츼CULO', '#ffcc00', 'btn-obs')">
            OBST츼CULO
        </button>
        
        <button id="btn-acc" class="btn-comisario btn-acc" onclick="enviarEstado('游댮 ACCIDENTE', 'red', 'btn-acc')">
            ACCIDENTE
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIGURACI칍N FIREBASE (La misma que el M치ster)
        const firebaseConfig = { databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ESCUCHAR CAMBIOS (Desde M치ster u otros Comisarios)
        onValue(ref(db, 'estado_pista'), (snapshot) => {
            const data = snapshot.val();
            if (data) {
                const banner = document.getElementById('banner');
                banner.innerText = data.mensaje;
                banner.style.backgroundColor = data.color;
                banner.style.color = (data.color === '#ffcc00') ? 'black' : 'white';

                // Resaltar bot칩n activo
                document.querySelectorAll('.btn-comisario').forEach(btn => {
                    btn.classList.add('inactive');
                    btn.classList.remove('active-now');
                });
                const activeBtn = document.getElementById(data.id);
                if (activeBtn) {
                    activeBtn.classList.remove('inactive');
                    activeBtn.classList.add('active-now');
                }
            }
        });

        // ENVIAR ESTADO Y DISPARAR VOTACI칍N
        window.enviarEstado = async (msg, col, id) => {
            // Vibraci칩n t치ctil si el dispositivo lo permite
            if (navigator.vibrate) navigator.vibrate(50);

            // 1. Cambiar estado de la pista
            set(ref(db, 'estado_pista'), { mensaje: msg, color: col, id: id });

            // 2. Si es Pista Libre, ejecutar l칩gica de cierre de votos (Igual que en el M치ster)
            if (id === 'btn-libre') {
                const snap = await get(ref(db, 'votacion_activa'));
                const v = snap.val();

                if (v && v.activa) {
                    // Guardar en historial antes de cerrar
                    Object.entries(v.items).forEach(([idItem, data]) => {
                        if ((data.ap || 0) + (data.up || 0) + (data.dw || 0) > 0) {
                            push(ref(db, 'historial_votos'), {
                                dorsal: idItem,
                                info: data.nombre,
                                ap: data.ap || 0,
                                up: data.up || 0,
                                dw: data.dw || 0,
                                ts: Date.now()
                            });
                        }
                    });

                    // Iniciar cuenta atr치s de 5 segundos
                    let count = 5;
                    update(ref(db, 'votacion_activa'), { timer: count });
                    
                    let interval = setInterval(() => {
                        count--;
                        update(ref(db, 'votacion_activa'), { timer: count });
                        if (count <= 0) {
                            clearInterval(interval);
                            set(ref(db, 'votacion_activa'), { activa: false, timer: 0 });
                        }
                    }, 1000);
                }
            }
        };
    </script>
</body>
</html>
