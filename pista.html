<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PISTA DRIFT SHOW</title>
    <style>
        /* Ajuste general para que todo quepa en la pantalla sin scroll */
        body { 
            background: #000; 
            margin: 0; 
            padding: 1.5vh; 
            display: flex; 
            flex-direction: column; 
            height: 97vh; 
            font-family: sans-serif; 
            box-sizing: border-box;
        }
        
        /* BANNER DE MENSAJES */
        #banner-mensaje { 
            display: none; 
            background: #ff8800; 
            color: #000;
            padding: 15px; 
            text-align: center; 
            border-radius: 12px; 
            margin-bottom: 1.5vh; 
            border: 3px solid #fff; 
            flex-shrink: 0; /* Para que no se encoja */
        }
        
        #texto-mensaje { 
            font-size: 1.8em; 
            font-weight: bold; 
            margin-bottom: 10px; 
            animation: parpadeo 1s infinite; 
            text-transform: uppercase;
        }

        .btn-cerrar-msg {
            background: #000;
            color: #ff8800;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 1.1em;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
        }

        /* BOTONES DE CONTROL - Se estiran para llenar el resto del espacio */
        .btn { 
            flex: 1; 
            margin-bottom: 1.5vh; 
            border-radius: 15px; 
            border: none; 
            font-size: 1.8em; 
            font-weight: bold; 
            color: #fff; 
            cursor: pointer; 
            opacity: 0.2; 
            transition: 0.3s; 
            text-transform: uppercase;
        }

        .btn:last-child { margin-bottom: 0; }

        .btn-act { 
            opacity: 1 !important; 
            outline: 5px solid #fff; 
            box-shadow: 0 0 20px rgba(255,255,255,0.5); 
        }

        .modo-bloqueado { opacity: 0.05 !important; pointer-events: none; }

        @keyframes parpadeo {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="banner-mensaje">
        <div id="texto-mensaje"></div>
        <button class="btn-cerrar-msg" onclick="cerrarMensajeLocal()">He le칤do [X]</button>
    </div>

    <button id="btn-coche" class="btn" style="background:#007bff" onclick="enviar('EN PISTA', '#007bff', 'btn-coche')">COCHE EN PISTA</button>
    <button id="btn-libre" class="btn" style="background:green" onclick="enviar('游릭 PISTA LIBRE', 'green', 'btn-libre')">PISTA LIBRE</button>
    <button id="btn-obs" class="btn" style="background:#ffcc00; color:black" onclick="enviar('丘멆잺 OBST츼CULO', '#ffcc00', 'btn-obs')">OBST츼CULO</button>
    <button id="btn-acc" class="btn" style="background:red" onclick="enviar('游댮 ACCIDENTE', 'red', 'btn-acc')">ACCIDENTE</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let modoActual = "tab-show";

        // CIERRE LOCAL DE MENSAJES
        window.cerrarMensajeLocal = () => {
            const textoMsg = document.getElementById('texto-mensaje').innerText;
            localStorage.setItem('msg_leido', textoMsg);
            document.getElementById('banner-mensaje').style.display = 'none';
        };

        // ESCUCHAR MENSAJES DEL MASTER
        onValue(ref(db, 'copilotajes/mensaje_pista'), (snap) => {
            const msg = snap.val();
            const banner = document.getElementById('banner-mensaje');
            const texto = document.getElementById('texto-mensaje');
            const yaLeido = localStorage.getItem('msg_leido');
            
            if (msg && msg.trim() !== "") {
                const formatoMsg = "游닉 " + msg;
                if (formatoMsg !== yaLeido) {
                    texto.innerText = formatoMsg;
                    banner.style.display = 'block';
                }
            } else {
                banner.style.display = 'none';
                localStorage.removeItem('msg_leido');
            }
        });

        // BLOQUEO POR MODO (ESC / SHOW)
        onValue(ref(db, 'modo_actual'), s => {
            modoActual = s.val() || "tab-show";
            document.querySelectorAll('.btn').forEach(b => {
                if(modoActual === 'tab-esc') b.classList.add('modo-bloqueado');
                else b.classList.remove('modo-bloqueado');
            });
        });

        // ENVIAR ESTADO DE PISTA
        window.enviar = async (m, c, id) => {
            if (id === 'btn-coche') {
                const vSnap = await get(ref(db, 'votacion_activa'));
                if (!vSnap.exists() || !vSnap.val().dorsal) {
                    alert("丘멆잺 ESPERA: El Master a칰n no ha puesto un dorsal.");
                    return;
                }
            }

            set(ref(db, 'estado_pista'), { mensaje: m, color: c, id: id });

            if (id === 'btn-libre') {
                const snap = await get(ref(db, 'votacion_activa'));
                const data = snap.val();
                if (data && data.activa) {
                    let acAp = 0, acUp = 0, acDw = 0;
                    const histSnap = await get(ref(db, 'historial_votos'));
                    if(histSnap.exists()){
                        Object.values(histSnap.val()).forEach(v => {
                            if(v.dorsal === data.dorsal) {
                                acAp += (v.ap || 0); acUp += (v.up || 0); acDw += (v.dw || 0);
                            }
                        });
                    }
                    push(ref(db, 'historial_votos'), {
                        dorsal: data.dorsal, info: data.info,
                        ap: (data.aplausos || 0) - acAp,
                        up: (data.up || 0) - acUp,
                        dw: (data.down || 0) - acDw,
                        ts: Date.now()
                    });
                    let count = 5;
                    update(ref(db, 'votacion_activa'), { timer: count });
                    let interval = setInterval(() => {
                        count--;
                        if (count <= 0) {
                            clearInterval(interval);
                            set(ref(db, 'votacion_activa'), { activa: false, info: "", dorsal: "", timer: 0 });
                        } else {
                            update(ref(db, 'votacion_activa'), { timer: count });
                        }
                    }, 1000);
                }
            }
        };

        // RESALTAR BOT칍N ACTIVO
        onValue(ref(db, 'estado_pista'), s => {
            const e = s.val();
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('btn-act'));
            if(e?.id) document.getElementById(e.id)?.classList.add('btn-act');
        });
    </script>
</body>
</html>
            border-radius: 8px;
            font-size: 1.3em;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 4px 0 #444;
        }

        .btn-cerrar-msg:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        /* Botones de Control de Pista */
        .btn { flex: 1; margin-bottom: 2vh; border-radius: 15px; border: none; font-size: 2em; font-weight: bold; color: #fff; cursor: pointer; opacity: 0.2; transition: 0.3s; }
        .btn-act { opacity: 1 !important; outline: 6px solid #fff; box-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .modo-bloqueado { opacity: 0.05 !important; pointer-events: none; }

        @keyframes parpadeo {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="banner-mensaje">
        <div id="texto-mensaje"></div>
        <button class="btn-cerrar-msg" onclick="cerrarMensajeLocal()">He le칤do el mensaje [X]</button>
    </div>

    <button id="btn-coche" class="btn" style="background:#007bff" onclick="enviar('EN PISTA', '#007bff', 'btn-coche')">COCHE EN PISTA</button>
    <button id="btn-libre" class="btn" style="background:green" onclick="enviar('游릭 PISTA LIBRE', 'green', 'btn-libre')">PISTA LIBRE</button>
    <button id="btn-obs" class="btn" style="background:#ffcc00; color:black" onclick="enviar('丘멆잺 OBST츼CULO', '#ffcc00', 'btn-obs')">OBST츼CULO</button>
    <button id="btn-acc" class="btn" style="background:red" onclick="enviar('游댮 ACCIDENTE', 'red', 'btn-acc')">ACCIDENTE</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let modoActual = "tab-show";

        // --- L칍GICA DE MENSAJER칈A CON CIERRE LOCAL ---
        window.cerrarMensajeLocal = () => {
            const textoMsg = document.getElementById('texto-mensaje').innerText;
            localStorage.setItem('msg_leido', textoMsg);
            document.getElementById('banner-mensaje').style.display = 'none';
        };

        onValue(ref(db, 'copilotajes/mensaje_pista'), (snap) => {
            const msg = snap.val();
            const banner = document.getElementById('banner-mensaje');
            const texto = document.getElementById('texto-mensaje');
            const yaLeido = localStorage.getItem('msg_leido');
            
            if (msg && msg.trim() !== "") {
                const formatoMsg = "游닉 " + msg;
                // Si el mensaje es distinto al guardado localmente, se muestra
                if (formatoMsg !== yaLeido) {
                    texto.innerText = formatoMsg;
                    banner.style.display = 'block';
                }
            } else {
                banner.style.display = 'none';
                localStorage.removeItem('msg_leido');
            }
        });

        // --- L칍GICA DE BOTONES Y SINCRONIZACI칍N ---
        onValue(ref(db, 'modo_actual'), s => {
            modoActual = s.val() || "tab-show";
            document.querySelectorAll('.btn').forEach(b => {
                if(modoActual === 'tab-esc') b.classList.add('modo-bloqueado');
                else b.classList.remove('modo-bloqueado');
            });
        });

        window.enviar = async (m, c, id) => {
            if (id === 'btn-coche') {
                const vSnap = await get(ref(db, 'votacion_activa'));
                if (!vSnap.exists() || !vSnap.val().dorsal) {
                    alert("丘멆잺 ESPERA: El Master a칰n no ha puesto un dorsal.");
                    return;
                }
            }

            set(ref(db, 'estado_pista'), { mensaje: m, color: c, id: id });

            if (id === 'btn-libre') {
                const snap = await get(ref(db, 'votacion_activa'));
                const data = snap.val();

                if (data && data.activa) {
                    let acAp = 0, acUp = 0, acDw = 0;
                    const histSnap = await get(ref(db, 'historial_votos'));
                    
                    if(histSnap.exists()){
                        Object.values(histSnap.val()).forEach(v => {
                            if(v.dorsal === data.dorsal) {
                                acAp += (v.ap || 0); acUp += (v.up || 0); acDw += (v.dw || 0);
                            }
                        });
                    }

                    push(ref(db, 'historial_votos'), {
                        dorsal: data.dorsal,
                        info: data.info,
                        ap: (data.aplausos || 0) - acAp,
                        up: (data.up || 0) - acUp,
                        dw: (data.down || 0) - acDw,
                        ts: Date.now()
                    });

                    let count = 5;
                    update(ref(db, 'votacion_activa'), { timer: count });
                    
                    let interval = setInterval(() => {
                        count--;
                        if (count <= 0) {
                            clearInterval(interval);
                            set(ref(db, 'votacion_activa'), { activa: false, info: "", dorsal: "", timer: 0 });
                        } else {
                            update(ref(db, 'votacion_activa'), { timer: count });
                        }
                    }, 1000);
                }
            }
        };

        onValue(ref(db, 'estado_pista'), s => {
            const e = s.val();
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('btn-act'));
            if(e?.id) document.getElementById(e.id)?.classList.add('btn-act');
        });
    </script>
</body>
</html>
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
        }

        /* Botones de Control de Pista */
        .btn { flex: 1; margin-bottom: 2vh; border-radius: 15px; border: none; font-size: 2em; font-weight: bold; color: #fff; cursor: pointer; opacity: 0.2; transition: 0.3s; }
        .btn-act { opacity: 1 !important; outline: 6px solid #fff; box-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .modo-bloqueado { opacity: 0.05 !important; pointer-events: none; }

        @keyframes parpadeo {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="banner-mensaje">
        <div id="texto-mensaje"></div>
        <button class="btn-cerrar-msg" onclick="cerrarMensajeLocal()">He le칤do el mensaje [X]</button>
    </div>

    <button id="btn-coche" class="btn" style="background:#007bff" onclick="enviar('EN PISTA', '#007bff', 'btn-coche')">COCHE EN PISTA</button>
    <button id="btn-libre" class="btn" style="background:green" onclick="enviar('游릭 PISTA LIBRE', 'green', 'btn-libre')">PISTA LIBRE</button>
    <button id="btn-obs" class="btn" style="background:#ffcc00; color:black" onclick="enviar('丘멆잺 OBST츼CULO', '#ffcc00', 'btn-obs')">OBST츼CULO</button>
    <button id="btn-acc" class="btn" style="background:red" onclick="enviar('游댮 ACCIDENTE', 'red', 'btn-acc')">ACCIDENTE</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let modoActual = "tab-show";

        // --- L칍GICA DE MENSAJER칈A CON CIERRE LOCAL ---
        window.cerrarMensajeLocal = () => {
            const msgActual = document.getElementById('texto-mensaje').innerText;
            localStorage.setItem('msg_leido', msgActual); // Guarda el texto exacto le칤do
            document.getElementById('banner-mensaje').style.display = 'none';
        };

        onValue(ref(db, 'copilotajes/mensaje_pista'), (snap) => {
            const msg = snap.val();
            const banner = document.getElementById('banner-mensaje');
            const texto = document.getElementById('texto-mensaje');
            const yaLeido = localStorage.getItem('msg_leido');
            
            if (msg && msg.trim() !== "") {
                const formatoMsg = "游닉 " + msg;
                // Si el mensaje nuevo es distinto al que el usuario cerr칩, se muestra
                if (formatoMsg !== yaLeido) {
                    texto.innerText = formatoMsg;
                    banner.style.display = 'block';
                }
            } else {
                banner.style.display = 'none';
                localStorage.removeItem('msg_leido'); // Limpia si el Master borra el mensaje
            }
        });

        // --- L칍GICA DE BOTONES Y SINCRONIZACI칍N ---
        onValue(ref(db, 'modo_actual'), s => {
            modoActual = s.val() || "tab-show";
            document.querySelectorAll('.btn').forEach(b => {
                if(modoActual === 'tab-esc') b.classList.add('modo-bloqueado');
                else b.classList.remove('modo-bloqueado');
            });
        });

        window.enviar = async (m, c, id) => {
            if (id === 'btn-coche') {
                const vSnap = await get(ref(db, 'votacion_activa'));
                if (!vSnap.exists() || !vSnap.val().dorsal) {
                    alert("丘멆잺 ESPERA: El Master a칰n no ha puesto un dorsal.");
                    return;
                }
            }

            set(ref(db, 'estado_pista'), { mensaje: m, color: c, id: id });

            if (id === 'btn-libre') {
                const snap = await get(ref(db, 'votacion_activa'));
                const data = snap.val();

                if (data && data.activa) {
                    let acAp = 0, acUp = 0, acDw = 0;
                    const histSnap = await get(ref(db, 'historial_votos'));
                    
                    if(histSnap.exists()){
                        Object.values(histSnap.val()).forEach(v => {
                            if(v.dorsal === data.dorsal) {
                                acAp += (v.ap || 0); acUp += (v.up || 0); acDw += (v.dw || 0);
                            }
                        });
                    }

                    push(ref(db, 'historial_votos'), {
                        dorsal: data.dorsal,
                        info: data.info,
                        ap: (data.aplausos || 0) - acAp,
                        up: (data.up || 0) - acUp,
                        dw: (data.down || 0) - acDw,
                        ts: Date.now()
                    });

                    let count = 5;
                    update(ref(db, 'votacion_activa'), { timer: count });
                    
                    let interval = setInterval(() => {
                        count--;
                        if (count <= 0) {
                            clearInterval(interval);
                            set(ref(db, 'votacion_activa'), { activa: false, info: "", dorsal: "", timer: 0 });
                        } else {
                            update(ref(db, 'votacion_activa'), { timer: count });
                        }
                    }, 1000);
                }
            }
        };

        onValue(ref(db, 'estado_pista'), s => {
            const e = s.val();
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('btn-act'));
            if(e?.id) document.getElementById(e.id)?.classList.add('btn-act');
        });
    </script>
</body>
</html>


