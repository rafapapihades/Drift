<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>PISTA - DRIFT SHOW</title>
  <style>
    * { box-sizing: border-box; }
    body { background:#000; margin:0; padding:10px; height:100vh; display:flex; flex-direction:column; gap:10px; font-family:sans-serif; overflow:hidden; }
    .btn-pista { flex:1; border:none; border-radius:15px; color:white; font-size:1.8em; font-weight:bold; text-transform:uppercase; cursor:pointer; transition:0.3s; display:flex; align-items:center; justify-content:center; text-align:center; padding:10px; }
    .btn-libre { background:#008000; }
    .btn-coche { background:#007bff; }
    .btn-obs   { background:#ffcc00; color:#000; }
    .btn-acc   { background:#cc0000; }
    .active-now { opacity:1 !important; outline:6px solid #fff; outline-offset:-6px; box-shadow:0 0 40px rgba(255,255,255,0.3); z-index:2; }
    .inactive { opacity:0.15; transform:scale(0.95); }

    #toast {
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff4444;
      color: white;
      padding: 20px;
      border-radius: 10px;
      font-weight: bold;
      width: 90%;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      transition: 0.5s;
      z-index: 9999;
      text-transform: uppercase;
    }
    #toast.show { top: 20px; }
  </style>
</head>
<body>

<div id="toast">‚ö†Ô∏è Espera a que el M√°ster asigne piloto</div>

<button id="btn-libre" class="btn-pista btn-libre" onclick="enviarEstado('üü¢ PISTA LIBRE','green','btn-libre')">PISTA LIBRE</button>
<button id="btn-coche" class="btn-pista btn-coche" onclick="intentarCocheEnPista()">COCHE EN PISTA</button>
<button id="btn-obs" class="btn-pista btn-obs" onclick="enviarEstado('‚ö†Ô∏è OBST√ÅCULO','#ffcc00','btn-obs')">OBST√ÅCULO</button>
<button id="btn-acc" class="btn-pista btn-acc" onclick="enviarEstado('üî¥ ACCIDENTE','red','btn-acc')">ACCIDENTE</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set, onValue, get, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const DB_URL = "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com";
  const db = getDatabase(initializeApp({ databaseURL: DB_URL }));

  let cierreInterval = null;
  let cierreEnCurso = false;

  function vibra(pat) { if (navigator.vibrate) navigator.vibrate(pat); }

  window.showToast = () => {
    const t = document.getElementById('toast');
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
    vibra([100, 50, 100]);
  };

  onValue(ref(db, 'estado_pista'), (snapshot) => {
    const data = snapshot.val();
    if (!data) return;

    document.querySelectorAll('.btn-pista').forEach(btn => {
      btn.classList.add('inactive');
      btn.classList.remove('active-now');
    });

    const activeBtn = document.getElementById(data.id);
    if (activeBtn) {
      activeBtn.classList.remove('inactive');
      activeBtn.classList.add('active-now');
    }
  });

  async function guardarHistorialSiHayVotos(v) {
    if (!v?.items) return;
    Object.entries(v.items).forEach(([idItem, data]) => {
      const total = (data.ap || 0) + (data.up || 0) + (data.dw || 0);
      if (total > 0) {
        push(ref(db, 'historial_votos'), {
          dorsal: idItem,
          info: data.nombre,
          ap: data.ap || 0,
          up: data.up || 0,
          dw: data.dw || 0,
          ts: Date.now()
        });
      }
    });
  }

  async function iniciarCierreVotacion() {
    if (cierreEnCurso) return;
    cierreEnCurso = true;

    if (cierreInterval) { clearInterval(cierreInterval); cierreInterval = null; }

    const snap = await get(ref(db, 'votacion_activa'));
    const v = snap.val();

    if (v && v.activa) {
      await guardarHistorialSiHayVotos(v);

      let count = 5;
      await update(ref(db, 'votacion_activa'), { timer: count });

      cierreInterval = setInterval(async () => {
        count--;
        await update(ref(db, 'votacion_activa'), { timer: count });

        if (count <= 0) {
          clearInterval(cierreInterval);
          cierreInterval = null;
          await set(ref(db, 'votacion_activa'), { activa: false, timer: 0, dorsal: "" });
          cierreEnCurso = false;
        }
      }, 1000);
    } else {
      cierreEnCurso = false;
    }
  }

  window.intentarCocheEnPista = async () => {
    const snapVot = await get(ref(db, 'votacion_activa'));
    const vot = snapVot.val();

    if (!vot || !vot.activa || !vot.dorsal) {
      showToast();
      return;
    }
    enviarEstado('üèéÔ∏è COCHE EN PISTA: ' + vot.dorsal, '#007bff', 'btn-coche');
  };

  window.enviarEstado = async (msg, col, id) => {
    vibra(60);
    await set(ref(db, 'estado_pista'), { mensaje: msg, color: col, id });

    if (id === 'btn-libre') {
      await set(ref(db, 'comando_limpiar'), Date.now());
      await iniciarCierreVotacion();
    }
  };
</script>
</body>
</html>
