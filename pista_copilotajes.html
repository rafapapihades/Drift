<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROL PISTA - TAXI DRIFT</title>
    <style>
        :root { --accent: #ffcc00; --bg: #000; --card: #1a1a1a; --green: #28a745; --red: #ff0000; --blue: #003399; --orange: #fd7e14; }
        
        body { 
            background-image: url('Fibra3.png'); 
            background-repeat: repeat; 
            background-color: var(--bg);
            color: #fff; 
            font-family: 'Arial Black', Gadget, sans-serif; 
            padding: 10px; margin: 0; 
        }

        .header { 
            text-align: center; padding: 15px; 
            background: rgba(0,0,0,0.9); border-radius: 12px;
            border-bottom: 3px solid var(--red); margin-bottom: 15px; 
        }

        /* ESTILO DE LOGO UNIFICADO */
        .header-logo { 
            display: block; 
            margin: 0 auto; 
            width: 100%;       
            max-width: 400px; 
            height: auto; 
            object-fit: contain;
        }

        .card { background: rgba(25, 25, 25, 0.95); padding: 15px; border-radius: 15px; border: 1px solid #444; margin-bottom: 20px; }
        .section-title { font-size: 0.8em; color: var(--accent); font-weight: bold; margin-bottom: 15px; text-transform: uppercase; }

        /* MATR√çCULA FORMATO REAL */
        .matricula {
            display: inline-flex;
            align-items: center;
            background: #fff;
            color: #000;
            border-radius: 4px;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            font-weight: 900;
            border: 1px solid #fff;
            margin-top: 5px;
        }
        .m-bandera { background: var(--blue); color: white; padding: 4px 5px; font-size: 0.6em; text-align: center; line-height: 1; }
        .m-num { padding: 2px 12px; font-size: 1.4em; min-width: 35px; text-align: center; }

        .n-doc { background: var(--accent); color: #000; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-weight: 900; margin-right: 5px; }

        table { width: 100%; border-collapse: collapse; }
        td { padding: 18px 8px; border-bottom: 1px solid #222; }

        .btn-pista { background: var(--green); color: white; border: none; padding: 15px 5px; border-radius: 8px; font-weight: 900; width: 100%; cursor: pointer; text-transform: uppercase; font-size: 0.85em; box-shadow: 0 4px 0 #155d27; }
        .btn-salida { background: var(--orange); color: white; border: none; padding: 12px 5px; border-radius: 8px; font-weight: 900; width: 100%; cursor: pointer; text-transform: uppercase; font-size: 0.75em; box-shadow: 0 4px 0 #a04e0e; }
        .btn-change { background: #222; color: var(--accent); border: 1px solid #444; padding: 10px; border-radius: 6px; font-size: 0.65em; cursor: pointer; margin-top: 10px; text-transform: uppercase; width: 100%; font-weight: bold; }

        #modal-cambio { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: #111; padding: 25px; border-radius: 15px; border: 2px solid var(--accent); width: 90%; max-width: 450px; text-align: center; }
        .select-modal { width: 100%; padding: 15px; margin: 20px 0; background: #000; color: #fff; border: 1px solid var(--accent); border-radius: 8px; font-size: 1.1em; }
    </style>
</head>
<body>

    <div class="header">
        <img src="logotaxi.jpg" alt="Logo Taxi Drift" class="header-logo">
    </div>

    <input type="search" id="buscador" style="width:100%; padding:15px; background:#000; border:1px solid #444; color:#fff; border-radius:10px; margin-bottom:15px;" placeholder="üîç BUSCAR DORSAL O NOMBRE..." oninput="filtrar()">

    <div class="card">
        <div class="section-title">üìã COLA DE ACCESO</div>
        <table><tbody id="lista-espera"></tbody></table>
    </div>

    <div class="card" style="border-color: var(--green);">
        <div class="section-title" style="color: var(--green);">üèÅ EN PISTA / RETORNO</div>
        <table><tbody id="lista-pista-activa"></tbody></table>
    </div>

    <div id="modal-cambio">
        <div class="modal-content">
            <h3 style="color: var(--accent); margin-bottom:5px;">REASIGNAR COCHE</h3>
            <select id="nuevo-piloto-select" class="select-modal"></select>
            <div style="display: flex; gap: 10px;">
                <button class="btn-pista" style="background: var(--blue); box-shadow: 0 4px 0 #002266;" onclick="ejecutarCambio()">REASIGNAR</button>
                <button class="btn-pista" style="background: #333; box-shadow: 0 4px 0 #111;" onclick="cerrarModal()">VOLVER</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove, get, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let idSeleccionado = null;
        let estadisticasViajes = {};
        let listaPilotosFB = [];

        function generarMatriculaHTML(pilotoData) {
            const dorsalMatch = pilotoData.match(/\[#(\d+)\]/) || pilotoData.match(/^(\d+)/);
            const num = dorsalMatch ? dorsalMatch[1] : "??";
            let nombreLimpio = pilotoData.replace(/\[#\d+\]/, "").replace(/^\d+[\s,.-]*/, "").split('|')[0].trim();

            return `
                <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
                    <div class="matricula">
                        <div class="m-bandera">E</div>
                        <div class="m-num">${num}</div>
                    </div>
                    <span style="font-size:1.1em; color:#fff;">${nombreLimpio}</span>
                </div>
            `;
        }

        window.confirmarSubida = async (id) => {
            const snap = await get(ref(db, `copilotajes/espera/${id}`));
            if(snap.exists()){
                const data = snap.val();
                const newRef = push(ref(db, 'copilotajes/completados'));
                await set(newRef, { ...data, horaPista: new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}), finalizado: false });
                await remove(ref(db, `copilotajes/espera/${id}`));
            }
        };

        window.confirmarSalidaRecinto = async (id) => {
            if(confirm("¬øACOMPA√ëADO A LA SALIDA?")) {
                await update(ref(db, `copilotajes/completados/${id}`), { finalizado: true });
            }
        };

        window.abrirModalCambio = (id) => {
            idSeleccionado = id;
            const sugerido = listaPilotosFB.reduce((prev, curr) => (estadisticasViajes[prev] || 0) <= (estadisticasViajes[curr] || 0) ? prev : curr, listaPilotosFB[0]);
            document.getElementById('nuevo-piloto-select').value = sugerido;
            document.getElementById('modal-cambio').style.display = 'flex';
        };

        window.cerrarModal = () => document.getElementById('modal-cambio').style.display = 'none';

        window.ejecutarCambio = async () => {
            const nuevo = document.getElementById('nuevo-piloto-select').value;
            await update(ref(db, `copilotajes/espera/${idSeleccionado}`), { piloto: nuevo });
            cerrarModal();
        };

        onValue(ref(db, 'copilotajes'), (snap) => {
            const data = snap.val() || {};
            const sel = document.getElementById('nuevo-piloto-select');
            sel.innerHTML = ""; listaPilotosFB = [];
            if(data.config_pilotos) {
                Object.values(data.config_pilotos).forEach(p => {
                    listaPilotosFB.push(p);
                    let opt = document.createElement('option');
                    opt.value = p;
                    const dMatch = p.match(/\[#(\d+)\]/) || p.match(/^(\d+)/);
                    const nLimpio = p.replace(/\[#\d+\]/, "").replace(/^\d+[\s,.-]*/, "").split('|')[0].trim();
                    opt.innerText = `DORSAL ${dMatch ? dMatch[1] : '?' } - ${nLimpio}`;
                    sel.appendChild(opt);
                });
            }

            estadisticasViajes = {};
            const todos = [...Object.values(data.espera || {}), ...Object.values(data.completados || {})];
            todos.forEach(v => { estadisticasViajes[v.piloto] = (estadisticasViajes[v.piloto] || 0) + 1; });

            const tEspera = document.getElementById('lista-espera'); tEspera.innerHTML = "";
            if(data.espera) {
                Object.keys(data.espera).forEach(id => {
                    const item = data.espera[id];
                    if(item.enRecinto) {
                        tEspera.innerHTML += `<tr><td>
                            <span class="n-doc">${item.nPapel.toString().padStart(3, '0')}</span> <b>${item.copiloto}</b>
                            ${generarMatriculaHTML(item.piloto)}
                            <button class="btn-change" onclick="abrirModalCambio('${id}')">üîÑ CAMBIAR COCHE (SIGUIENTE)</button>
                        </td><td style="width:100px"><button class="btn-pista" onclick="confirmarSubida('${id}')">EN PISTA</button></td></tr>`;
                    }
                });
            }

            const tPista = document.getElementById('lista-pista-activa'); tPista.innerHTML = "";
            if(data.completados) {
                Object.keys(data.completados).forEach(id => {
                    const item = data.completados[id];
                    if(item.finalizado === false) {
                        tPista.innerHTML += `<tr><td>
                            <span class="n-doc" style="background:#444; color:#fff">${item.nPapel.toString().padStart(3, '0')}</span> <b>${item.copiloto}</b>
                            <div style="transform: scale(0.8); origin: left center; opacity:0.8;">${generarMatriculaHTML(item.piloto)}</div>
                        </td><td style="width:140px"><button class="btn-salida" onclick="confirmarSalidaRecinto('${id}')">ACOMPA√ëADO A SALIDA</button></td></tr>`;
                    }
                });
            }
        });

        window.filtrar = () => {
            const b = document.getElementById('buscador').value.toLowerCase();
            document.querySelectorAll('tr').forEach(tr => tr.style.display = tr.innerText.toLowerCase().includes(b) ? '' : 'none');
        };
    </script>
</body>
</html>

