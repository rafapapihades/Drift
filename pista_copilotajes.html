<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROL PISTA - TAXI DRIFT</title>
    <style>
        :root { --accent: #ffcc00; --bg: #000; --card: #1a1a1a; --green: #28a745; --red: #ff0000; --blue: #007bff; --orange: #fd7e14; }
        
        body { 
            background-image: url('Fibra3.png'); 
            background-repeat: repeat; 
            background-color: var(--bg);
            color: #fff; 
            font-family: 'Arial Black', Gadget, sans-serif; 
            padding: 10px; margin: 0; 
        }

        .header { 
            text-align: center; padding: 15px; 
            background: rgba(0,0,0,0.9); border-radius: 12px;
            border-bottom: 3px solid var(--red); margin-bottom: 15px; 
        }
        .header h2 { margin: 0; color: var(--red); text-transform: uppercase; font-size: 1.4em; }

        .card { background: rgba(25, 25, 25, 0.95); padding: 15px; border-radius: 15px; border: 1px solid #444; margin-bottom: 20px; }
        .section-title { font-size: 0.8em; color: var(--accent); font-weight: bold; margin-bottom: 15px; text-transform: uppercase; }

        /* ESTILO DORSAL TIPO MATR√çCULA */
        .dorsal-container {
            display: inline-flex;
            align-items: center;
            background: #fff;
            color: #000;
            border-radius: 4px;
            overflow: hidden;
            font-family: monospace;
            font-weight: 900;
            margin-right: 10px;
            border: 1px solid #ccc;
        }
        .dorsal-blue { background: #003399; color: white; padding: 2px 4px; font-size: 0.6em; display: flex; align-items: center; }
        .dorsal-num { padding: 2px 8px; font-size: 1.2em; }

        .n-doc { background: var(--accent); color: #000; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-weight: 900; margin-right: 5px; }

        table { width: 100%; border-collapse: collapse; }
        td { padding: 15px 8px; border-bottom: 1px solid #222; }

        .btn-pista { background: var(--green); color: white; border: none; padding: 15px 5px; border-radius: 8px; font-weight: 900; width: 100%; cursor: pointer; text-transform: uppercase; font-size: 0.85em; box-shadow: 0 4px 0 #155d27; }
        .btn-salida { background: var(--orange); color: white; border: none; padding: 12px 5px; border-radius: 8px; font-weight: 900; width: 100%; cursor: pointer; text-transform: uppercase; font-size: 0.75em; box-shadow: 0 4px 0 #a04e0e; }
        .btn-change { background: #222; color: var(--accent); border: 1px solid #444; padding: 8px; border-radius: 4px; font-size: 0.65em; cursor: pointer; margin-top: 8px; text-transform: uppercase; width: 100%; font-family: sans-serif; font-weight: bold; }

        #modal-cambio { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: #111; padding: 25px; border-radius: 15px; border: 2px solid var(--accent); width: 90%; max-width: 450px; text-align: center; }
        .select-modal { width: 100%; padding: 15px; margin: 20px 0; background: #000; color: #fff; border: 1px solid var(--accent); border-radius: 8px; font-size: 1.1em; }
    </style>
</head>
<body>

    <div class="header">
        <h2>CONTROL PISTA TAXI DRIFT</h2>
    </div>

    <input type="search" id="buscador" style="width:100%; padding:15px; background:#000; border:1px solid #444; color:#fff; border-radius:10px; margin-bottom:15px;" placeholder="üîç BUSCAR COPILOTO O DORSAL..." oninput="filtrar()">

    <div class="card">
        <div class="section-title">üìã EN RECINTO (ESPERANDO COCHE)</div>
        <table><tbody id="lista-espera"></tbody></table>
    </div>

    <div class="card" style="border-color: var(--green);">
        <div class="section-title" style="color: var(--green);">üèÅ EN PISTA ACTUALMENTE</div>
        <table><tbody id="lista-pista-activa"></tbody></table>
    </div>

    <div id="modal-cambio">
        <div class="modal-content">
            <h3 style="color: var(--accent); margin-bottom:5px;">REASIGNAR COCHE</h3>
            <select id="nuevo-piloto-select" class="select-modal"></select>
            <div style="display: flex; gap: 10px;">
                <button class="btn-pista" style="background: var(--blue); box-shadow: 0 4px 0 #0056b3;" onclick="ejecutarCambio()">REASIGNAR</button>
                <button class="btn-pista" style="background: #333; box-shadow: 0 4px 0 #111;" onclick="cerrarModal()">VOLVER</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, remove, get, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://lectura-sonido-drift-show-default-rtdb.firebaseio.com" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let idSeleccionado = null;
        let estadisticasViajes = {};
        let listaPilotosFull = [];

        // Funci√≥n para renderizar el dorsal bonito
        function renderDorsal(textoPiloto) {
            // Intentamos extraer el n√∫mero si viene en formato [#1]
            const match = textoPiloto.match(/\[#(\d+)\]/);
            const num = match ? match[1] : "??";
            const nombreLimpio = textoPiloto.replace(/\[#\d+\]/, "").trim();
            
            return `
                <div class="dorsal-container">
                    <div class="dorsal-blue">E</div>
                    <div class="dorsal-num">${num}</div>
                </div>
                <b style="font-size:1.1em;">${nombreLimpio}</b>
            `;
        }

        window.confirmarSubida = async (id) => {
            const snap = await get(ref(db, `copilotajes/espera/${id}`));
            if(snap.exists()){
                const data = snap.val();
                const newRef = push(ref(db, 'copilotajes/completados'));
                await set(newRef, { ...data, horaPista: new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}), finalizado: false });
                await remove(ref(db, `copilotajes/espera/${id}`));
            }
        };

        window.confirmarSalidaRecinto = async (id) => {
            if(confirm("¬øACOMPA√ëADO A LA SALIDA?")) {
                await update(ref(db, `copilotajes/completados/${id}`), { finalizado: true });
            }
        };

        window.abrirModalCambio = (id) => {
            idSeleccionado = id;
            // Sugerir el que menos viajes tenga
            const sugerido = listaPilotosFull.reduce((prev, curr) => (estadisticasViajes[prev] || 0) <= (estadisticasViajes[curr] || 0) ? prev : curr, listaPilotosFull[0]);
            document.getElementById('nuevo-piloto-select').value = sugerido;
            document.getElementById('modal-cambio').style.display = 'flex';
        };

        window.cerrarModal = () => document.getElementById('modal-cambio').style.display = 'none';

        window.ejecutarCambio = async () => {
            const nuevo = document.getElementById('nuevo-piloto-select').value;
            await update(ref(db, `copilotajes/espera/${idSeleccionado}`), { piloto: nuevo });
            cerrarModal();
        };

        onValue(ref(db, 'copilotajes'), (snap) => {
            const data = snap.val() || {};
            
            // 1. Cargar pilotos configurados
            const sel = document.getElementById('nuevo-piloto-select');
            sel.innerHTML = ""; listaPilotosFull = [];
            if(data.config_pilotos) {
                Object.values(data.config_pilotos).forEach(p => {
                    listaPilotosFull.push(p);
                    let opt = document.createElement('option'); opt.value = p; opt.innerText = p;
                    sel.appendChild(opt);
                });
            }

            // 2. Calcular viajes
            estadisticasViajes = {};
            const todos = [...Object.values(data.espera || {}), ...Object.values(data.completados || {})];
            todos.forEach(v => { estadisticasViajes[v.piloto] = (estadisticasViajes[v.piloto] || 0) + 1; });

            // 3. Render Espera
            const tEspera = document.getElementById('lista-espera'); tEspera.innerHTML = "";
            if(data.espera) {
                Object.keys(data.espera).forEach(id => {
                    const item = data.espera[id];
                    if(item.enRecinto) {
                        tEspera.innerHTML += `
                            <tr>
                                <td>
                                    <span class="n-doc">${item.nPapel.toString().padStart(3, '0')}</span> <b>${item.copiloto}</b><br>
                                    <div style="margin-top:10px; display:flex; align-items:center;">
                                        ${renderDorsal(item.piloto)}
                                    </div>
                                    <button class="btn-change" onclick="abrirModalCambio('${id}')">üîÑ REASIGNAR SIGUIENTE</button>
                                </td>
                                <td style="width:100px"><button class="btn-pista" onclick="confirmarSubida('${id}')">EN PISTA</button></td>
                            </tr>`;
                    }
                });
            }

            // 4. Render Pista
            const tPista = document.getElementById('lista-pista-activa'); tPista.innerHTML = "";
            if(data.completados) {
                Object.keys(data.completados).forEach(id => {
                    const item = data.completados[id];
                    if(item.finalizado === false) {
                        tPista.innerHTML += `
                            <tr>
                                <td>
                                    <span class="n-doc" style="background:#444; color:#fff">${item.nPapel.toString().padStart(3, '0')}</span> <b>${item.copiloto}</b><br>
                                    <div style="margin-top:5px; transform: scale(0.8); origin: left center; display:flex; align-items:center; opacity:0.8;">
                                        ${renderDorsal(item.piloto)}
                                    </div>
                                </td>
                                <td style="width:140px"><button class="btn-salida" onclick="confirmarSalidaRecinto('${id}')">ACOMPA√ëADO A SALIDA</button></td>
                            </tr>`;
                    }
                });
            }
        });

        window.filtrar = () => {
            const b = document.getElementById('buscador').value.toLowerCase();
            document.querySelectorAll('tr').forEach(tr => {
                tr.style.display = tr.innerText.toLowerCase().includes(b) ? '' : 'none';
            });
        };
    </script>
</body>
</html>
